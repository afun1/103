<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparky Screen Recorder</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#1e2852; color:#333; min-height:100vh; }
        .container { width:100%; min-height:100vh; display:flex; flex-direction:column; }
        .header-container { width:100%; height:80px; position:sticky; top:0; z-index:1000; }
        .main-content { flex:1; display:flex; flex-direction:column; align-items:center; gap:30px; padding:20px; }
        .preview-section { width:100%; display:flex; justify-content:center; }
        .preview-screen { width:66%; aspect-ratio:16/9; border:10px solid #333; border-radius:8px; background:#666; display:flex; align-items:center; justify-content:center; color:#666; font-size:18px; position:relative; overflow:hidden; }
        .controls-section { width:66%; background:#666; border:10px solid #333; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); display:flex; gap:40px; }
        .controls-left { flex:1; }
        .controls-title { font-size:20px; font-weight:700; margin-bottom:20px; color:#fff; }
        .record-button-section { width:100%; display:flex; justify-content:center; margin:10px 0; }
        .record-button { padding:15px 40px; border:2px solid #0f5132; border-radius:12px; font-size:18px; font-weight:700; cursor:pointer; color:#fff; background:linear-gradient(180deg,#198754 0%,#0f5132 100%); box-shadow:0 4px 8px rgba(0,0,0,0.3); transition:all .3s ease; min-width:200px; }
        @keyframes greenGlow {0%{box-shadow:0 0 20px rgba(34,197,94,1),0 0 40px rgba(34,197,94,.8),0 0 60px rgba(34,197,94,.6),0 4px 8px rgba(34,197,94,.4),inset 0 1px 0 rgba(255,255,255,.3);}100%{box-shadow:0 0 30px rgba(34,197,94,1),0 0 50px rgba(34,197,94,.9),0 0 80px rgba(34,197,94,.7),0 6px 12px rgba(34,197,94,.5),inset 0 1px 0 rgba(255,255,255,.4);}}
        .record-button:hover { transform:translateY(-2px); box-shadow:0 0 15px rgba(34,197,94,.6),0 0 25px rgba(34,197,94,.3),0 6px 12px rgba(0,0,0,.4); background:linear-gradient(180deg,#20c997 0%,#198754 100%); border-color:rgba(34,197,94,.7); }
        .record-button.lighting-up { color:#1e40af; background:linear-gradient(180deg,#86efac 0%,#15803d 100%); border-color:rgba(34,197,94,.9); animation:greenGlow 2s ease-in-out infinite alternate; }
        @keyframes redGlow {0%{box-shadow:0 0 20px rgba(220,38,38,1),0 0 40px rgba(220,38,38,.8),0 0 60px rgba(220,38,38,.6),0 4px 8px rgba(220,38,38,.4),inset 0 1px 0 rgba(255,255,255,.3);}100%{box-shadow:0 0 30px rgba(220,38,38,1),0 0 50px rgba(220,38,38,.9),0 0 80px rgba(220,38,38,.7),0 6px 12px rgba(220,38,38,.5),inset 0 1px 0 rgba(255,255,255,.4);}}
        .record-button.recording { color:#000; background:linear-gradient(180deg,#fca5a5 0%,#dc2626 100%); border-color:rgba(220,38,38,.9); animation:redGlow 1s ease-in-out infinite alternate; }
        .metadata-form { width:66%; margin:20px 0; }
        .form-container { background:#666; border:10px solid #333; border-radius:12px; padding:30px; box-shadow:0 4px 12px rgba(0,0,0,.1); }
        .form-title { font-size:24px; font-weight:700; color:#fff; text-align:center; margin-bottom:30px; }
        .radio-group { display:flex; gap:30px; justify-content:center; margin-bottom:30px; }
        .radio-option { display:flex; align-items:center; cursor:pointer; color:#fff; font-size:16px; font-weight:600; }
        .radio-option input { display:none; }
        .radio-custom { width:20px; height:20px; border:2px solid #ccc; border-radius:50%; margin-right:10px; position:relative; background:#fff; }
        .radio-option input:checked + .radio-custom { border-color:#4CAF50; }
        .radio-option input:checked + .radio-custom::after { content:''; width:10px; height:10px; background:#4CAF50; border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
        .form-label { display:block; color:#fff; font-weight:600; margin:8px 0 8px; font-size:14px; }
        .form-label.required::after { content:' *'; color:#ff4444; }
        .form-input, .search-input, .form-textarea { width:100%; padding:12px; border:1px solid #ccc; border-radius:6px; font-size:16px; background:#fff; }
        .form-textarea { resize:vertical; min-height:100px; }
        .confirm-button { background:linear-gradient(180deg,#4CAF50 0%,#45a049 100%); color:#fff; border:none; padding:15px 40px; border-radius:8px; font-size:18px; font-weight:700; cursor:pointer; transition:.3s; min-width:200px; }
        .confirm-button:hover { transform:translateY(-2px); box-shadow:0 6px 12px rgba(76,175,80,.4); }
        #userVideoGrid h2 { color:#fff; }
        .video-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:20000; padding:24px; padding-top: 80px; /* Push content below sticky header */ }
        .video-modal-overlay.open { display:flex; }
        .video-modal-content { width:100%; max-width:1200px; background:#000; border-radius:10px; overflow:hidden; position:relative; }
        .video-modal-close { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.06); color:#fff; border:none; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; }
        .video-modal-body video, .video-modal-body iframe { width:100%; height:70vh; max-height:80vh; background:#000; display:block; }
        .video-metadata-section { width:100%; background:#1a1a1a; display:flex; border-top:1px solid #333; }
        .video-metadata-left { width:33%; background:#2a2a2a; padding:20px; border-right:1px solid #333; }
        .video-metadata-right { width:67%; padding:20px; background:#1a1a1a; }
        .metadata-item { color:#e2e8f0; font-size:14px; line-height:1.4; margin-bottom:8px; word-wrap:break-word; word-break:break-word; }
        .metadata-description { 
            color:#cbd5e1; 
            font-size:14px; 
            line-height:1.5; 
            word-wrap:break-word; 
            word-break:break-word;
            white-space: pre-wrap; /* Respect newlines and wrap text */
            max-height: 30vh; /* Limit height */
            overflow-y: auto; /* Add scrollbar if needed */
        }

        .search-container {
            position: relative;
        }
        .suggestions-dropdown {
            position: absolute;
            width: 100%;
            background: #444;
            border: 1px solid #888;
            border-radius: 0 0 6px 6px;
            z-index: 10;
            max-height: 250px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            color: #fff;
            border-bottom: 1px solid #555;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background: #555;
        }
        .suggestion-item small {
            color: #bbb;
        }
        
        #videoGrid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        /* Responsive Design for Video Grid */
        @media (max-width: 1200px) {
            #videoGrid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 900px) {
            #videoGrid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) {
            #videoGrid {
                grid-template-columns: repeat(1, 1fr);
            }
        }

        /* Responsive Design for Controls Section */
        @media (max-width: 888px) {
            .controls-section {
                width: 85%;
                padding: 18px;
            }
            
            .controls-left > div:first-child > div {
                flex-direction: column !important;
                gap: 12px !important;
                align-items: center !important;
            }
            
            .controls-left > div:first-child > div > label {
                margin-left: 0 !important;
                text-align: center;
            }
        }
        
        @media (max-width: 768px) {
            .controls-section {
                width: 90%;
                padding: 15px;
            }
            
            .controls-left > div:first-child > div {
                flex-direction: column !important;
                gap: 15px !important;
                align-items: center !important;
            }
            
            .controls-left > div:first-child > div > label {
                margin-left: 0 !important;
                text-align: center;
            }
            
            .audio-meters > div {
                flex-direction: column !important;
                gap: 15px !important;
            }
            
            .preview-screen {
                width: 90%;
            }
            
            .metadata-form {
                width: 90%;
            }
        }
        
        @media (max-width: 480px) {
            .controls-section {
                width: 95%;
                padding: 10px;
            }
            
            .controls-left > div:first-child > div {
                gap: 10px !important;
            }
            
            .audio-meters > div > div {
                flex-direction: column !important;
                gap: 8px !important;
                align-items: center !important;
            }
            
            .audio-meters > div > div > div:first-child {
                gap: 5px !important;
            }
            
            .audio-meter-compact {
                width: 60px !important;
            }
            
            .preview-screen {
                width: 95%;
            }
            
            .metadata-form {
                width: 95%;
            }
            
            .main-content {
                gap: 20px;
                padding: 10px;
            }
        }

        @media (max-width: 416px) {
            #audioProcessingControls {
                flex-direction: column;
                align-items: stretch !important;
                gap: 15px !important;
            }
            #systemGainControl, #micGainControl {
                justify-content: center;
                border-left: none !important;
                padding-left: 0 !important;
                flex-wrap: wrap; /* Allow items inside to wrap */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container"></div>
        <div class="main-content">
            <div class="preview-section">
                <div class="preview-screen">
                    <img src="Sparky-AItp.gif" alt="Sparky AI" style="max-width:200px;max-height:200px;object-fit:contain;">
                </div>
            </div>
            <div class="record-button-section" id="recordButtonSection">
                <button class="record-button" id="recordButton" onclick="handleRecordButtonClick()">🔴 Start Recording</button>
            </div>
            <div class="metadata-form" id="metadataForm" style="display:none;">
                <div class="form-container">
                    <h2 class="form-title">Recording Complete - Add Details</h2>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="customerType" value="existing" onchange="toggleCustomerForm('existing')"><span class="radio-custom"></span>Existing Customer</label>
                        <label class="radio-option"><input type="radio" name="customerType" value="new" onchange="toggleCustomerForm('new')"><span class="radio-custom"></span>New Customer</label>
                    </div>
                    <div id="existingCustomerForm" class="customer-form" style="display:none;">
                        <div style="display: flex; justify-content: center;">
                            <div class="search-container" style="width: 50%;">
                                <label class="form-label">Search Customer</label>
                                <input type="text" id="customerSearch" placeholder="Type name or email..." oninput="loadAndSearchCustomers(this.value)" class="search-input">
                                <div id="customerSuggestions" class="suggestions-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    <div id="newCustomerForm" class="customer-form" style="display:none;">
                        <div class="form-row" style="display:flex; gap:20px; justify-content: center;">
                            <div style="flex: 0 1 50%;">
                                <label class="form-label required">First Name</label>
                                <input type="text" id="firstName" required class="form-input">
                            </div>
                            <div style="flex: 0 1 50%;">
                                <label class="form-label required">Last Name</label>
                                <input type="text" id="lastName" required class="form-input">
                            </div>
                        </div>
                        <label class="form-label required">Email</label>
                        <input type="email" id="email" required class="form-input">
                    </div>
                    <!-- Description field moved to be common for both forms -->
                    <div id="commonFields" style="display:none;">
                        <label class="form-label">Description (Optional)</label>
                        <textarea id="description" class="form-textarea" placeholder="Add any additional notes..." maxlength="5000"></textarea>
                    </div>
                    <div style="text-align:center;margin-top:30px;">
                        <button class="confirm-button" onclick="confirmUpload()">📤 Confirm Upload</button>
                    </div>
                </div>
            </div>
            <div class="controls-section" id="controlsSection">
                <div class="controls-left">
                    <!-- Row 1: Settings Dropdowns -->
                    <div style="display:flex;justify-content:center;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:15px;">
                        <label class="control-label" style="margin-bottom:0;font-size:14px;color:#fff;">Audio Source:</label>
                        <select id="audioSource" class="setting-select" style="padding:2px 6px;font-size:12px;height:24px;">
                            <option value="none" selected>No Audio</option>
                            <option value="system">System Audio</option>
                            <option value="mic">Microphone</option>
                            <option value="mixed">System + Mic</option>
                        </select>
                        <label class="control-label" style="margin-bottom:0;font-size:14px;color:#fff;">Video Settings:</label>
                        <select class="setting-select" style="padding:2px 6px;font-size:12px;height:24px;" id="quality">
                            <option value="480p" selected>480p SD</option>
                            <option value="720p">720p HD</option>
                            <option value="1080p">1080p Full HD</option>
                            <option value="4k">4K Ultra HD</option>
                        </select>
                        <select class="setting-select" style="padding:2px 6px;font-size:12px;height:24px;" id="framerate">
                            <option value="30">30 FPS</option>
                            <option value="60" selected>60 FPS</option>
                        </select>
                    </div>
                    <!-- Row 2: Audio Meters and Sliders -->
                    <div id="audioProcessingControls" style="display:none; justify-content:center; align-items:center; gap: 12px; flex-wrap: wrap; border-top: 1px solid #888; padding-top: 15px;">
                        <!-- System Audio Controls -->
                        <div id="systemGainControl" style="display:none; align-items:center; gap: 8px; border-left: 2px solid #aaa; padding-left: 8px;">
                            <label class="control-label" style="margin-bottom:0;font-size:14px;color:#fff;">System:</label>
                            <input id="systemGainSlider" type="range" min="0" max="2" step="0.1" value="1" style="width:80px;cursor:pointer;">
                            <span id="systemGainValue" style="color:#fff;font-size:12px;min-width:34px;text-align:left;">1.0x</span>
                            <!-- Master Out Meter is now here -->
                            <div id="masterGainControl" style="display:flex;align-items:center;gap:6px; border-left: 2px solid #4CAF50; padding-left: 8px;">
                                <div style="font-size:11px;color:#ccc;">Out:</div>
                                <div style="width:100px;height:10px;background:#1b1b1b;border:1px solid #444;border-radius:5px;overflow:hidden;position:relative;">
                                    <div id="outputMeterFill" style="height:100%;width:0%;background:#4caf50;transition:width .1s linear;"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Mic Audio Controls -->
                        <div id="micGainControl" style="display:none; align-items:center; gap: 8px; border-left: 2px solid #aaa; padding-left: 8px;">
                            <label class="control-label" style="margin-bottom:0;font-size:14px;color:#fff;">Mic:</label>
                            <input id="micGainSlider" type="range" min="0" max="3" step="0.1" value="1" style="width:80px;cursor:pointer;">
                            <span id="micGainValue" style="color:#fff;font-size:12px;min-width:34px;text-align:left;">1.0x</span>
                            <div style="display:flex;align-items:center;gap:4px;">
                                <div style="font-size:11px;color:#ccc;">In:</div>
                                <div style="width:60px;height:10px;background:#1b1b1b;border:1px solid #444;border-radius:5px;overflow:hidden;position:relative;">
                                    <div id="micMeterFill" style="height:100%;width:0%;background:#4caf50;transition:width .1s linear;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="userVideoGrid" style="width:100%;max-width:1200px;margin:30px auto 0;padding:0 20px;">
                <div style="background:#333;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);padding:24px;border:2px solid #555;">
                    <h2 style="margin:0 0 20px;color:#fff;font-size:24px;font-weight:600;display:flex;align-items:center;gap:10px;justify-content:center;">
                        <span>📹</span>My Recordings
                        <span id="videoCountBadge" style="background:#4CAF50;color:#fff;padding:4px 12px;border-radius:16px;font-size:14px;font-weight:500;">0</span>
                    </h2>
                    <div id="videoGrid">
                        <div style="grid-column:1 / -1;display:flex;justify-content:center;align-items:center;height:100px;color:#ccc;font-size:16px;">Loading your recordings...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="global-header.js"></script>
    <script>
        let isRecording=false,mediaRecorder=null,recordedChunks=[]; let selectedCustomer=null,customerSearchTimeout=null;
        
        // --- App State ---
        let appState = 'idle'; // idle, ready, recording
        
        // --- Audio & Stream State ---
        let audioCtx=null, masterGainNode=null, micGainNode=null, systemGainNode=null;
        let outputAnalyser=null, outputDataArray=null, meterAnimationFrame=null;
        let micInputAnalyser=null, micInputDataArray=null, inputMeterAnimationFrame=null;
        let systemInputAnalyser=null, systemInputDataArray=null, systemMeterAnimationFrame=null;
        let liveStream = null; // Will hold the stream from getDisplayMedia/getUserMedia

        // Utility function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Added helper to reliably get current user info from global header / localStorage
        function getCurrentUserInfo(){
            const fallback={displayName:'Unknown User', email:'unknown@example.com'};
            try{
                if(window.currentUser && (window.currentUser.email||window.currentUser.name)){
                    return {displayName: window.currentUser.displayName||window.currentUser.name||fallback.displayName, email: window.currentUser.email||fallback.email};
                }
                if(window.__currentUser && (window.__currentUser.email||window.__currentUser.name)){
                    return {displayName: window.__currentUser.displayName||window.__currentUser.name||fallback.displayName, email: window.__currentUser.email||fallback.email};
                }
                if(window.getCurrentUser && typeof window.getCurrentUser==='function'){
                    const u=window.getCurrentUser();
                    if(u && (u.email||u.name||u.displayName)) return {displayName:u.displayName||u.name||fallback.displayName, email:u.email||fallback.email};
                }
                // NEW: Direct global header elements
                const directEmailEl=document.getElementById('user-email');
                const directNameEl=document.getElementById('user-name');
                if(directEmailEl){
                    const emailTxt=(directEmailEl.textContent||'').trim();
                    if(emailTxt && /@/.test(emailTxt)){
                        const nameTxt=(directNameEl?.textContent||'').trim();
                        return {displayName: nameTxt||fallback.displayName, email: emailTxt};
                    }
                }
                if(document.body){
                    const be=document.body.getAttribute('data-user-email');
                    const bn=document.body.getAttribute('data-user-name');
                    if(be) return {displayName:(bn||'').trim()||fallback.displayName, email:be};
                }
                const anyDataEl=document.querySelector('[data-user-email]');
                if(anyDataEl){
                    const email=anyDataEl.getAttribute('data-user-email');
                    const nameAttr=anyDataEl.getAttribute('data-user-name')||anyDataEl.textContent||'';
                    if(email) return {displayName:nameAttr.trim()||fallback.displayName, email};
                }
                const emailEl=document.querySelector('#userEmail, .user-email, #user-email, [class*="userEmail"], [id*="userEmail"]');
                if(emailEl){
                    const txt=emailEl.textContent||emailEl.value||'';
                    const mail=txt.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                    if(mail){
                        let name='';
                        const parent=emailEl.closest('div,li,span,header');
                        if(parent){
                            const nameCand=parent.querySelector('.user-name, #user-name, [data-user-name]');
                            if(nameCand) name=nameCand.textContent||nameCand.getAttribute('data-user-name')||'';
                        }
                        return {displayName:name.trim()||fallback.displayName, email:mail[1]};
                    }
                }
                const headerUser=document.querySelector('.user-info, .userName, .header-user');
                if(headerUser){
                    const txt=headerUser.textContent||'';
                    const mail=txt.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                    if(mail){
                        const email=mail[1];
                        const name=txt.replace(email,'').replace(/[()|,-]/g,' ').trim();
                        return {displayName:name||fallback.displayName, email};
                    }
                }
                const ls=JSON.parse(localStorage.getItem('currentUser')||'{}');
                if(ls && (ls.email||ls.name||ls.displayName)) return {displayName: ls.displayName||ls.name||fallback.displayName, email: ls.email||fallback.email};
            }catch(e){ }
            return fallback;
        }
        function isFallbackUser(u){return !u || u.email==='unknown@example.com';}
        async function getResolvedUserInfo(maxWait=2000){
            const start=Date.now();
            let u=getCurrentUserInfo();
            if(!isFallbackUser(u)) return u;
            while(Date.now()-start<maxWait){
                await new Promise(r=>setTimeout(r,200));
                u=getCurrentUserInfo();
                if(!isFallbackUser(u)) return u;
            }
            return u; // fallback if still unknown
        }

        function tearDownAudio() {
            if (liveStream) {
                liveStream.getTracks().forEach(track => track.stop());
                liveStream = null;
            }
            if (audioCtx) {
                audioCtx.close().catch(()=>{});
                audioCtx = null;
            }
            if (meterAnimationFrame) cancelAnimationFrame(meterAnimationFrame);
            if (inputMeterAnimationFrame) cancelAnimationFrame(inputMeterAnimationFrame);
            if (systemMeterAnimationFrame) cancelAnimationFrame(systemMeterAnimationFrame);
            
            const micMeter = document.getElementById('micMeterFill');
            if(micMeter) micMeter.style.width = '0%';
            const systemMeter = document.getElementById('systemMeterFill');
            if(systemMeter) systemMeter.style.width = '0%';
            const outMeter = document.getElementById('outputMeterFill');
            if(outMeter) outMeter.style.width = '0%';

            masterGainNode = null;
            micGainNode = null;
            systemGainNode = null;
            outputAnalyser = null;
            micInputAnalyser = null;
            systemInputAnalyser = null;
        }

        async function setupStreamsAndAudio() {
            tearDownAudio(); // Clean up any previous state

            const audioChoice = document.getElementById('audioSource').value;
            const btn = document.getElementById('recordButton');
            btn.classList.add('lighting-up');
            btn.textContent = 'Getting Permissions...';
            btn.disabled = true;

            try {
                const captureSystemAudio = audioChoice === 'system' || audioChoice === 'mixed';
                const captureMicAudio = audioChoice === 'mic' || audioChoice === 'mixed';

                // 1. Get initial streams
                let systemAudioTrack = null;
                let micAudioTrack = null;

                // Always get video stream first
                liveStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' },
                    audio: captureSystemAudio
                });

                if (captureSystemAudio) {
                    systemAudioTrack = liveStream.getAudioTracks()[0];
                    if (!systemAudioTrack) {
                        alert('System audio was requested, but not captured. Please ensure you check "Share tab audio" or "Share system audio".');
                    }
                }
                
                if (captureMicAudio) {
                    try {
                        const micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
                        micAudioTrack = micStream.getAudioTracks()[0];
                        liveStream.addTrack(micAudioTrack);
                    } catch (e) {
                        console.warn("Could not get microphone audio.", e);
                        alert("Could not get microphone. Recording may have partial or no audio.");
                    }
                }

                // Set up the preview
                const preview = document.querySelector('.preview-screen');
                const v = document.createElement('video');
                v.srcObject = liveStream;
                v.autoplay = true; v.muted = true;
                v.style.width = '100%'; v.style.height = '100%'; v.style.objectFit = 'contain';
                preview.innerHTML = '';
                preview.appendChild(v);

                // 2. Setup Web Audio graph if any audio track was captured
                if (systemAudioTrack || micAudioTrack) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    await audioCtx.resume();
                    
                    masterGainNode = audioCtx.createGain();
                    outputAnalyser = audioCtx.createAnalyser();
                    outputAnalyser.fftSize = 256;
                    outputDataArray = new Uint8Array(outputAnalyser.frequencyBinCount);
                    
                    masterGainNode.connect(outputAnalyser);

                    if (systemAudioTrack) {
                        const systemSource = audioCtx.createMediaStreamSource(new MediaStream([systemAudioTrack]));
                        systemInputAnalyser = audioCtx.createAnalyser();
                        systemInputAnalyser.fftSize = 256;
                        systemInputDataArray = new Uint8Array(systemInputAnalyser.frequencyBinCount);
                        systemGainNode = audioCtx.createGain();
                        systemSource.connect(systemInputAnalyser);
                        systemInputAnalyser.connect(systemGainNode);
                        systemGainNode.connect(masterGainNode);
                        startSystemMeter();
                    }

                    if (micAudioTrack) {
                        const micSource = audioCtx.createMediaStreamSource(new MediaStream([micAudioTrack]));
                        micInputAnalyser = audioCtx.createAnalyser();
                        micInputAnalyser.fftSize = 256;
                        micInputDataArray = new Uint8Array(micInputAnalyser.frequencyBinCount);
                        micGainNode = audioCtx.createGain();
                        micSource.connect(micInputAnalyser);
                        micInputAnalyser.connect(micGainNode);
                        micGainNode.connect(masterGainNode);
                        startInputMeter();
                    }
                    startOutputMeter();
                }
                
                // Update UI for 'ready' state
                appState = 'ready';
                btn.classList.remove('lighting-up');
                btn.textContent = '✅ Confirm & Record';
                btn.disabled = false;

            } catch (err) {
                console.error("Error setting up audio/video:", err);
                alert("Could not set up audio/video. Please grant permissions and try again.");
                resetToIdleState();
            }
        }

        function handleRecordButtonClick() {
            switch (appState) {
                case 'idle':
                    setupStreamsAndAudio();
                    break;
                case 'ready':
                    startRecording();
                    break;
                case 'recording':
                    stopRecording();
                    break;
            }
        }
        
        async function startRecording(){
            try {
                const btn=document.getElementById('recordButton');
                btn.classList.remove('lighting-up');
                btn.classList.add('recording');
                btn.innerHTML='⏹️ Stop Recording';
                appState = 'recording';
                isRecording = true;

                if (!liveStream) {
                    throw new Error("No stream available to record. Please set up first.");
                }

                let finalAudioTrack = null;
                if (audioCtx && masterGainNode) {
                    const recordDestination = audioCtx.createMediaStreamDestination();
                    masterGainNode.connect(recordDestination);
                    finalAudioTrack = recordDestination.stream.getAudioTracks()[0];
                }

                const finalStreamForRecorder = new MediaStream([
                    ...liveStream.getVideoTracks(),
                    ...(finalAudioTrack ? [finalAudioTrack] : [])
                ]);

                const options = { mimeType: finalAudioTrack ? 'video/webm;codecs=vp9,opus' : 'video/webm;codecs=vp9' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }

                mediaRecorder=new MediaRecorder(finalStreamForRecorder, options);
                recordedChunks=[];
                mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
                mediaRecorder.onstop=()=>{
                    const blob=new Blob(recordedChunks,{type:'video/webm'});
                    window.recordedVideoBlob=blob;
                    const blobUrl=URL.createObjectURL(blob);

                    try{
                        if(typeof window.addLocalRecordingToGrid==='function'){
                            window.addLocalRecordingToGrid(blobUrl,{ customerName:'Local Recording', description:'Recently recorded session', recordingDate:new Date().toISOString(), customerEmail:''});
                        }
                    }catch(e){}
                    document.getElementById('recordButtonSection').style.display='none';
                    document.getElementById('controlsSection').style.display='none';
                    document.getElementById('metadataForm').style.display='block';
                    
                    const preview = document.querySelector('.preview-screen');
                    preview.innerHTML = ''; // Clear previous content

                    // Create a video element to capture the last frame
                    const video = document.createElement('video');
                    video.muted = true;
                    video.src = blobUrl;

                    video.onloadedmetadata = () => {
                        // Seek to near the end to get the last frame
                        video.currentTime = video.duration;
                    };

                    video.onseeked = () => {
                        // Create a canvas to draw the frame
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        // Create an image element with the canvas content
                        const img = document.createElement('img');
                        img.src = canvas.toDataURL('image/jpeg');
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'contain';
                        
                        // Replace preview content with the static image
                        preview.innerHTML = '';
                        preview.appendChild(img);
                        
                        // The blobUrl is not revoked here so the video player in the grid still works
                    };
                };
                mediaRecorder.start();

            } catch(err) {
                console.error('Error starting recording:',err);
                alert('Error: Could not start recording.');
                resetToIdleState();
            }
        }

        function stopRecording(){
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
            resetToIdleState();
        }

        function resetToIdleState() {
            tearDownAudio();
            appState = 'idle';
            isRecording = false;
            
            const btn = document.getElementById('recordButton');
            btn.classList.remove('recording', 'lighting-up');
            btn.textContent = '🔴 Start Recording';
            btn.disabled = false;
            
            const preview = document.querySelector('.preview-screen');
            preview.innerHTML='<img src="Sparky-AItp.gif" alt="Sparky AI" style="max-width:200px;max-height:200px;object-fit:contain;">';
        }

        let allCustomers = []; // Cache for all customers

        function toggleCustomerForm(t) {
            const ex = document.getElementById('existingCustomerForm');
            const nw = document.getElementById('newCustomerForm');
            const common = document.getElementById('commonFields');

            if (t === 'existing') {
                ex.style.display = 'block';
                nw.style.display = 'none';
                common.style.display = 'block';
                // Load ALL customers immediately and show list
                loadAndSearchCustomers('');
                setTimeout(()=>{
                    const input = document.getElementById('customerSearch');
                    if(input) input.focus();
                },50);
            } else {
                ex.style.display = 'none';
                nw.style.display = 'block';
                common.style.display = 'block';
                setTimeout(()=>document.getElementById('firstName')?.focus(),50);
            }
            selectedCustomer = null;
        }

        async function loadAndSearchCustomers(query = '') {
            const suggestions = document.getElementById('customerSuggestions');
            const searchInput = document.getElementById('customerSearch');

            // If we already have cache and just filtering
            const hasCache = allCustomers.length > 0;

            // Try to populate cache if empty
            if (!hasCache) {
                let customerList = [];
                let sourcePayload = null;

                // 1. Try primary Vimeo videos endpoint
                try {
                    const resp = await fetch('/api/folder-videos');
                    if (!resp.ok) throw new Error('folder-videos non-OK ' + resp.status);
                    sourcePayload = await resp.json();

                    // Normalize possible shapes
                    const possibleArrays = [];
                    if (Array.isArray(sourcePayload)) possibleArrays.push(sourcePayload);
                    if (sourcePayload && Array.isArray(sourcePayload.videos)) possibleArrays.push(sourcePayload.videos);
                    if (sourcePayload && Array.isArray(sourcePayload.data)) possibleArrays.push(sourcePayload.data);
                    if (sourcePayload && Array.isArray(sourcePayload.items)) possibleArrays.push(sourcePayload.items);
                    if (sourcePayload && sourcePayload.results && Array.isArray(sourcePayload.results)) possibleArrays.push(sourcePayload.results);

                    const base = possibleArrays.find(a => a.length) || [];

                    base.forEach(v => {
                        if (!v) return;
                        const desc = v.description || '';
                        let name = v.customerName || v.name || '';
                        let email = v.customerEmail || '';
                        if (!email && desc) {
                            const m = desc.match(/Customer Email:\s*([^\s\n\r]+)/i);
                            if (m) email = m[1].trim();
                        }
                        if (!name && desc) {
                            const nMatch = desc.match(/Customer:\s*([^\n\r]+)/i);
                            if (nMatch) name = nMatch[1].trim();
                        }
                        if (name && email) {
                            const key = email.toLowerCase();
                            if (!customerList.some(c => c.email.toLowerCase() === key)) {
                                const parts = name.split(/\s+/);
                                customerList.push({
                                    name,
                                    email,
                                    firstName: parts[0] || '',
                                    lastName: parts.slice(1).join(' ') || ''
                                });
                            }
                        }
                    });
                } catch (e) {
                    console.warn('Primary /api/folder-videos failed:', e);
                }

                // 2. Fallback to /api/customers if no results
                if (customerList.length === 0) {
                    try {
                        const resp2 = await fetch('/api/customers');
                        if (resp2.ok) {
                            const payload2 = await resp2.json();
                            const arr = Array.isArray(payload2) ? payload2 : (Array.isArray(payload2?.data) ? payload2.data : []);
                            arr.forEach(c => {
                                if (!c) return;
                                const name = c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim();
                                const email = c.email || '';
                                if (name && email && !customerList.some(x => x.email.toLowerCase() === email.toLowerCase())) {
                                    const parts = name.split(/\s+/);
                                    customerList.push({
                                        name,
                                        email,
                                        firstName: c.firstName || parts[0] || '',
                                        lastName: c.lastName || parts.slice(1).join(' ') || ''
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('Fallback /api/customers failed:', e);
                    }
                }

                // 3. Fallback to localStorage cached (from another page) if still empty
                if (customerList.length === 0) {
                    try {
                        const cached = JSON.parse(localStorage.getItem('sparkyCustomersCache') || '[]');
                        if (Array.isArray(cached) && cached.length > 0) {
                            customerList = cached;
                        }
                    } catch (e) {
                        /* ignore */
                    }
                }

                if (customerList.length === 0) {
                    suggestions.innerHTML = '<div class="suggestion-item">Error loading customers</div>';
                    suggestions.style.display = 'block';
                    return;
                }

                customerList.sort((a, b) => a.name.localeCompare(b.name));
                allCustomers = customerList;

                // Persist cache for reuse across pages/sessions
                try { localStorage.setItem('sparkyCustomersCache', JSON.stringify(allCustomers.slice(0, 2000))); } catch(e) {}
            }

            // Filter phase
            const q = (query || '').trim().toLowerCase();
            let list = !q ? allCustomers : allCustomers.filter(c => c.name.toLowerCase().includes(q) || c.email.toLowerCase().includes(q));

            if (list.length === 0) {
                suggestions.innerHTML = '<div class="suggestion-item">No customers found</div>';
                suggestions.style.display = 'block';
                return;
            }

            const limited = list.slice(0, 300);
            suggestions.innerHTML = limited.map(c => `<div class="suggestion-item" onclick="selectCustomer(${JSON.stringify(c).replace(/"/g,'&quot;')})"><strong>${c.name}</strong><br><small>${c.email}</small></div>`).join('');
            suggestions.style.display = 'block';
        }

        function displayCustomerSuggestions(customers){ const sug=document.getElementById('customerSuggestions'); sug.innerHTML=customers.map(c=>`<div class="suggestion-item" onclick="selectCustomer(${JSON.stringify(c).replace(/"/g,'&quot;')})"><strong>${c.name}</strong><br><small>${c.email}</small></div>`).join(''); sug.style.display='block'; }
        
        function selectCustomer(c){ 
            selectedCustomer=c; 
            document.getElementById('customerSearch').value=`${c.name} (${c.email})`; 
            document.getElementById('customerSuggestions').style.display='none'; 
        }

        async function confirmUpload(){ 
            const VIMEO_FOLDER_ID = '26555277'; // Target Vimeo folder ID
            const type=document.querySelector('input[name="customerType"]:checked')?.value; 
            if(!type){ alert('Select customer type'); return;} 
            
            let customerData={}; 
            let description = document.getElementById('description').value.trim(); 
            
            if(type==='existing'){ 
                if(!selectedCustomer){ alert('Select a customer'); return;} 
                customerData=selectedCustomer; 
            } else { 
                const fn=document.getElementById('firstName').value.trim(); 
                const ln=document.getElementById('lastName').value.trim(); 
                const em=document.getElementById('email').value.trim(); 
                if(!fn||!ln||!em){ alert('Fill required fields'); return;} 
                customerData={ name:`${fn} ${ln}`, firstName:fn, lastName:ln, email:em }; 
            } 
            
            const btn=document.querySelector('.confirm-button'); 
            btn.textContent='Uploading...'; 
            btn.disabled=true; 
            
            try{ 
                if(window.recordedVideoBlob){ 
                    const reader=new FileReader(); 
                    reader.onloadend=function(){ 
                        const base64Data = reader.result; 
                        // Extract base64 and mime
                        const match = base64Data.match(/^data:(.*?);base64,(.*)$/); 
                        const mimeType = match ? match[1] : 'video/webm'; 
                        const base64 = match ? match[2] : base64Data.split(',')[1];
                        getResolvedUserInfo().then(userInfo=>{ 
                            const recordedBy={ displayName:userInfo.displayName, email:userInfo.email }; 
                            
                            const fullDescription = `${description}\n\n--- RECORDING DETAILS ---\nCustomer: ${customerData.name}\nCustomer Email: ${customerData.email}\nRecorded By: ${recordedBy.displayName}\nRecorded By Email: ${recordedBy.email}\nRecording Date: ${new Date().toISOString()}`;

                            const payload={ 
                                videoData:base64, 
                                mimeType,
                                title: customerData.name, 
                                description: fullDescription, 
                                customerData, 
                                recordedBy,
                                folderId: VIMEO_FOLDER_ID // Ensure backend assigns to this Vimeo folder
                            }; 
                            
                            fetch('/api/upload-vimeo',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) })
                                .then(r=>r.json().catch(()=>({success:false,error:'Invalid JSON response'})))
                                .then(res=>{ 
                                    if(res.success){ 
                                        window.showBriefSuccessMessage(); 
                                        setTimeout(()=>window.autoResetForNextRecording(),1000); 
                                    } else { 
                                        console.error('Upload failed response:', res); 
                                        alert('Upload failed: ' + (res.error || 'Unknown error')); 
                                        btn.textContent='📤 Confirm Upload'; 
                                        btn.disabled=false; 
                                    } 
                                })
                                .catch(e=>{ 
                                    console.error('Upload request error:', e); 
                                    alert('Upload error: '+e.message); 
                                    btn.textContent='📤 Confirm Upload'; 
                                    btn.disabled=false; 
                                }); 
                        }); 
                    }; 
                    reader.readAsDataURL(window.recordedVideoBlob); 
                } else { 
                    alert('No video recorded'); 
                    btn.textContent='📤 Confirm Upload'; 
                    btn.disabled=false; 
                } 
            } catch(e){ 
                console.error('Unexpected upload error:', e); 
                alert('Upload error: '+e.message); 
                btn.textContent='📤 Confirm Upload'; 
                btn.disabled=false; 
            } 
        }
        if(typeof window.showBriefSuccessMessage==='undefined'){ window.showBriefSuccessMessage=function(){ const n=document.createElement('div'); n.innerHTML='✅ Upload Complete!'; n.style.cssText='position:fixed;top:120px;right:20px;background:#4CAF50;color:#fff;padding:12px 24px;border-radius:8px;font-weight:bold;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,.3);'; document.body.appendChild(n); setTimeout(()=>n.remove(),2500); }; }
        if(typeof window.autoResetForNextRecording==='undefined'){ window.autoResetForNextRecording=function(){ location.reload(); }; }
        window.addLocalRecordingToGrid=function(blobUrl,meta){ try{ const grid=document.getElementById('videoGrid'); if(!grid) return; const name=meta.customerName||'Local Recording'; const card=document.createElement('div'); card.className='video-card'; card.setAttribute('data-vimeo',blobUrl); card.setAttribute('data-title',name); card.setAttribute('data-description',meta.description||''); card.setAttribute('data-customer-email',meta.customerEmail||''); card.setAttribute('data-recording-date',meta.recordingDate||new Date().toLocaleString()); card.style='background:#444;border:2px solid #666;border-radius:12px;overflow:hidden;transition:.3s;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4);'; card.onclick=function(){ const userInfo=getCurrentUserInfo(); const metadata={customerName:name, customerEmail:this.dataset.customerEmail, recordedBy:userInfo.displayName, recordedByEmail:userInfo.email, recordingDate:this.dataset.recordingDate, description:this.dataset.description}; openVideoModal(this.dataset.vimeo,this.dataset.title,metadata); }; card.innerHTML=`<div style="position:relative;width:100%;height:160px;background:#000;display:flex;align-items:center;justify-content:center;color:#fff;">🎬</div><div style="padding:14px;"><div style="font-weight:700;font-size:15px;color:#4CAF50;margin-bottom:4px;">👤 ${name}</div><div style="font-size:11px;color:#bbb;margin-bottom:8px;">📧 ${meta.customerEmail||''}</div><div style="font-size:11px;color:#ccc;line-height:1.3;height:28px;overflow:hidden;">${meta.description||''}</div></div>`; grid.insertBefore(card,grid.firstChild); }catch(e){ console.warn('addLocalRecordingToGrid failed',e);} };
        function cleanLoadVideoLibrary(){ 
            let userEmail=''; 
            
            // Try multiple methods to get user email
            if(window.headerUserProfile && window.headerUserProfile.email) {
                userEmail = window.headerUserProfile.email;
            } else if(window.getCurrentUser){ 
                try{ userEmail=window.getCurrentUser()?.email||''; }catch{} 
            }
            
            // Check body data attributes set by global header
            if(!userEmail) {
                userEmail = document.body.getAttribute('data-user-email') || '';
            }
            
            // Check localStorage as fallback
            if(!userEmail){ 
                const stored=JSON.parse(localStorage.getItem('currentUser')||'{}'); 
                userEmail=stored.email||''; 
            } 
            
            // If still no email, wait for profile to load
            if(!userEmail) {
                console.log('⏳ Waiting for user profile to load...');
                document.addEventListener('profileLoaded', function(event) {
                    if(event.detail && event.detail.email) {
                        cleanLoadVideoLibrary();
                    }
                }, { once: true });
                return;
            }
            
            console.log('👤 Loading recordings for user:', userEmail);
            
            const grid=document.getElementById('videoGrid'); 
            const badge=document.getElementById('videoCountBadge'); 
            if(!grid) return; 
            
            grid.innerHTML='<div style="grid-column:1/-1;display:flex;justify-content:center;align-items:center;height:100px;color:#666;font-size:16px;">Loading recordings for '+userEmail+'...</div>'; 
            
            // Use the correct API endpoint
            fetch('/api/user-recordings/'+encodeURIComponent(userEmail))
                .then(r=>{
                    if(!r.ok) {
                        throw new Error('HTTP ' + r.status);
                    }
                    return r.json();
                })
                .then(videos=>{ 
                    console.log(`📹 Loaded ${videos.length} recordings for ${userEmail}`);
                    badge.textContent=videos.length; 
                    if(!videos.length){ 
                        grid.innerHTML='<div style="grid-column:1/-1;padding:40px;text-align:center;color:#ccc;">No recordings found for '+userEmail+'</div>'; 
                        return;
                    } 
                    let html=''; 
                    videos.forEach(video=>{ 
                        const date=new Date(video.recordingDate).toLocaleDateString(); 
                        const name=video.customerName||'Unknown'; 
                        const fullDesc=video.description||'';                 const recordedByMatch=fullDesc.match(/Recorded By:\s*([^\n\r]+)/);
                const recordedByEmailMatch=fullDesc.match(/Recorded By Email:\s*([^\n\r]+)/);
                let recordedByName='Unknown';
                let recordedByEmail='';
                if(recordedByMatch && recordedByEmailMatch){
                    recordedByName=recordedByMatch[1].trim();
                    recordedByEmail=recordedByEmailMatch[1].trim();
                } else if(video.recordedBy && video.recordedBy.displayName && video.recordedBy.email){
                    recordedByName=video.recordedBy.displayName;
                    recordedByEmail=video.recordedBy.email;
                } else {
                    const userInfo=getCurrentUserInfo();
                    recordedByName=userInfo.displayName || 'Unknown';
                    recordedByEmail=userInfo.email || '';
                } 
                const mainDesc = fullDesc.split('--- RECORDING DETAILS ---')[0].trim();
                const desc = mainDesc || fullDesc;
                html+=`<div class="video-card" style="background:#444;border:2px solid #666;border-radius:12px;overflow:hidden;transition:.3s;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4);" data-vimeo-url="${escapeHtml(video.vimeoLink)}" data-video-name="${escapeHtml(name)}" data-video-description="${escapeHtml(fullDesc)}"><div style="position:relative;width:100%;height:160px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;">${video.thumbnail?`<img src='${escapeHtml(video.thumbnail)}' style='width:100%;height:100%;object-fit:cover;'>`:`<div style='text-align:center;'><div style='font-size:36px;margin-bottom:8px;'>🎬</div><div style='font-size:12px;opacity:.8;'>Click to View</div></div>`}<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,.8);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px;font-weight:bold;border:1px solid #4CAF50;">${escapeHtml(date)}</div></div><div style="padding:14px;"><div style="font-weight:700;font-size:15px;color:#4CAF50;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">👤 ${escapeHtml(name)}</div><div style="font-size:11px;color:#bbb;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">📧 ${escapeHtml(video.customerEmail||'')}</div><div style="font-size:12px;color:#ffeb3b;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">🎬 ${escapeHtml(recordedByName)}</div><div style="font-size:10px;color:#ddd;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">📨 ${escapeHtml(recordedByEmail)}</div><div style="font-size:10px;color:#aaa;margin-bottom:8px;font-family:monospace;">🕒 ${escapeHtml(new Date(video.recordingDate).toLocaleString())}</div><div style="font-size:11px;color:#ccc;line-height:1.4;height:4.2em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;background:rgba(0,0,0,.3);padding:4px 6px;border-radius:4px;border-left:3px solid #4CAF50; word-break: break-word; white-space: pre-wrap;">📝 ${escapeHtml(desc)}</div></div></div>`; }); grid.innerHTML=html; }); }
        document.addEventListener('DOMContentLoaded',()=>{ 
            setTimeout(cleanLoadVideoLibrary,1200); 
            
            // Add event delegation for video cards to handle clicks safely
            setTimeout(() => {
                const grid = document.getElementById('videoGrid');
                if (grid) {
                    grid.addEventListener('click', function(e) {
                        const videoCard = e.target.closest('.video-card');
                        if (videoCard) {
                            const url = videoCard.getAttribute('data-vimeo-url');
                            const name = videoCard.getAttribute('data-video-name');
                            const description = videoCard.getAttribute('data-video-description');
                            
                            if (url && name && description) {
                                console.log('🎬 Video card clicked safely:', {url, name});
                                openVideoModalWithMetadata(url, name, description);
                            } else {
                                console.error('Missing video data on card:', {url, name, description});
                            }
                        }
                    });
                }
            }, 2000);
        });
        function openVideoModal(url,title,metadata=null){ 
            try{ 
                console.log('🎬 Opening video modal for URL:', url);
                
                const modal=document.getElementById('videoModal'); 
                const inner=document.getElementById('videoModalInner'); 
                inner.innerHTML=''; 
                
                // Validate URL first
                if (!url || typeof url !== 'string') {
                    console.error('Invalid URL provided to video modal:', url);
                    alert('Invalid video URL. Cannot open video.');
                    return;
                }
                
                if(/vimeo\.com|player\.vimeo\.com/.test(url)){ 
                    let src=url; 
                    if(/^https:\/\/(www\.)?vimeo\.com\/.+/.test(url)){ 
                        const m=url.match(/vimeo\.com\/(?:video\/)?(\d+)/); 
                        if(m&&m[1]) {
                            src=`https://player.vimeo.com/video/${m[1]}?autoplay=1`;
                            console.log('🔄 Converted Vimeo URL to player URL:', src);
                        }
                    } else if(url.indexOf('player.vimeo.com')!==-1 && url.indexOf('autoplay')===-1){ 
                        src+= (url.indexOf('?')===-1?'?':'&')+'autoplay=1'; 
                    } 
                    
                    const iframe=document.createElement('iframe'); 
                    iframe.src=src; 
                    iframe.allow='autoplay; fullscreen; picture-in-picture'; 
                    iframe.allowFullscreen=true; 
                    iframe.frameBorder='0';
                    
                    // Add error handling for iframe
                    iframe.onerror = function() {
                        console.error('Failed to load Vimeo video:', src);
                        inner.innerHTML = '<div style="color:#fff;padding:40px;text-align:center;">Failed to load video. <br><a href="' + url + '" target="_blank" style="color:#4CAF50;">Open in new tab</a></div>';
                    };
                    
                    inner.appendChild(iframe);
                    
                } else if(url && url.startsWith('blob:')){ 
                    const v=document.createElement('video'); 
                    v.src=url; 
                    v.controls=true; 
                    v.autoplay=true; 
                    v.playsInline=true; 
                    v.addEventListener('canplay',()=>{ 
                        const p=v.play(); 
                        if(p&&p.catch)p.catch(()=>{}); 
                    }); 
                    inner.appendChild(v);
                    
                } else if(url && /(\.mp4|\.webm|\.ogg)$/i.test(url)){ 
                    const v=document.createElement('video'); 
                    v.src=url; 
                    v.controls=true; 
                    v.autoplay=true; 
                    v.playsInline=true; 
                    v.addEventListener('canplay',()=>{ 
                        const p=v.play(); 
                        if(p&&p.catch)p.catch(()=>{}); 
                    }); 
                    inner.appendChild(v);
                    
                } else { 
                    console.log('🔗 Opening URL in new tab:', url);
                    window.open(url,'_blank'); 
                    return;
                } 
                
                const metadataSection=document.getElementById('videoMetadataSection'); 
                if(metadata){ 
                    const items=document.getElementById('metadataItems'); 
                    const desc=document.getElementById('metadataDescription'); 
                    let html=''; 
                    if(metadata.customerName) html+=`<div class="metadata-item">👤 ${escapeHtml(metadata.customerName)}</div>`; 
                    if(metadata.customerEmail) html+=`<div class="metadata-item">📧 ${escapeHtml(metadata.customerEmail)}</div>`; 
                    if(metadata.recordedBy) html+=`<div class="metadata-item">🎬 ${escapeHtml(metadata.recordedBy)}</div>`; 
                    if(metadata.recordedByEmail) html+=`<div class="metadata-item">📨 ${escapeHtml(metadata.recordedByEmail)}</div>`; 
                    if(metadata.recordingDate) html+=`<div class="metadata-item">🕒 ${escapeHtml(metadata.recordingDate)}</div>`; 
                    items.innerHTML=html; 
                    desc.textContent=(metadata.description||'No description available'); 
                    metadataSection.style.display='flex'; 
                } else { 
                    metadataSection.style.display='none'; 
                } 
                
                modal._ignoreClicks=true; 
                modal.classList.add('open'); 
                modal.setAttribute('aria-hidden','false'); 
                setTimeout(()=>{ modal._ignoreClicks=false; },50); 
                modal._previouslyFocused=document.activeElement; 
                const closeBtn = document.getElementById('videoModalClose');
                if (closeBtn) closeBtn.focus();
                
            }catch(e){ 
                console.error('Error in openVideoModal:', e); 
                alert('Error opening video: ' + e.message);
                window.open(url,'_blank'); 
            }
        }
        function closeVideoModal(){ const modal=document.getElementById('videoModal'); if(!modal) return; const inner=document.getElementById('videoModalInner'); const el=inner.querySelector('video,iframe'); if(el){ try{ if(el.tagName.toLowerCase()==='video'){ el.pause(); if(el.src && el.src.startsWith('blob:')) URL.revokeObjectURL(el.src);} if(el.tagName.toLowerCase()==='iframe') el.src=''; }catch{} } inner.innerHTML=''; modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); const prev=modal._previouslyFocused; if(prev&&prev.focus) prev.focus(); }
        document.addEventListener('click',e=>{ const modal=document.getElementById('videoModal'); if(!modal||!modal.classList.contains('open')) return; if(modal._ignoreClicks) return; const content=modal.querySelector('.video-modal-content'); if(!content.contains(e.target)) closeVideoModal(); });
        document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ const modal=document.getElementById('videoModal'); if(modal&&modal.classList.contains('open')) closeVideoModal(); }});
        function openVideoModalWithMetadata(url,title,description){ const recordedByMatch=description.match(/Recorded By:\s*([^\n\r]+)/); const recordedByEmailMatch=description.match(/Recorded By Email:\s*([^\n\r]+)/); const customerEmailMatch=description.match(/Customer Email:\s*([^\n\r]+)/); const recordingDateMatch=description.match(/Recording Date:\s*([^\n\r]+)/); const userInfo=getCurrentUserInfo(); 
            const mainDesc = description.split('--- RECORDING DETAILS ---')[0].trim();
            const cleanDesc = mainDesc || description || 'No description available';
            const metadata={customerName:title, customerEmail:customerEmailMatch?customerEmailMatch[1].trim():'', recordedBy:recordedByMatch?recordedByMatch[1].trim():userInfo.displayName, recordedByEmail:recordedByEmailMatch?recordedByEmailMatch[1].trim():userInfo.email, recordingDate:recordingDateMatch?recordingDateMatch[1].trim():new Date().toLocaleString(), description:cleanDesc}; openVideoModal(url,title,metadata); } window.openVideoModal=openVideoModal; window.closeVideoModal=closeVideoModal; window.openVideoModalWithMetadata=openVideoModalWithMetadata;
        
        // --- Settings Persistence ---
        function saveSettings() {
            try {
                const settings = {
                    audioSource: document.getElementById('audioSource').value,
                    quality: document.getElementById('quality').value,
                    framerate: document.getElementById('framerate').value,
                    systemGain: document.getElementById('systemGainSlider').value,
                    micGain: document.getElementById('micGainSlider').value,
                };
                localStorage.setItem('sparkyRecorderSettings', JSON.stringify(settings));
            } catch (e) {
                console.warn("Could not save settings.", e);
            }
        }

        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('sparkyRecorderSettings'));
                if (settings) {
                    document.getElementById('audioSource').value = settings.audioSource || 'none';
                    document.getElementById('quality').value = settings.quality || '480p';
                    document.getElementById('framerate').value = settings.framerate || '60';
                    document.getElementById('systemGainSlider').value = settings.systemGain || '1';
                    document.getElementById('micGainSlider').value = settings.micGain || '1';

                    // Manually trigger events to update UI that depends on these values
                    document.getElementById('audioSource').dispatchEvent(new Event('change'));
                    document.getElementById('systemGainSlider').dispatchEvent(new Event('input'));
                    document.getElementById('micGainSlider').dispatchEvent(new Event('input'));
                }
            } catch (e) {
                console.warn("Could not load settings.", e);
            }
        }

        // --- Audio UI Handlers ---
        document.getElementById('audioSource').addEventListener('change', function() {
            const audioControls = document.getElementById('audioProcessingControls');
            const systemControls = document.getElementById('systemGainControl');
            const micControls = document.getElementById('micGainControl');
            const masterControls = document.getElementById('masterGainControl');

            const showSystem = this.value === 'system' || this.value === 'mixed';
            const showMic = this.value === 'mic' || this.value === 'mixed';
            
            if (this.value === 'none') {
                audioControls.style.display = 'none';
            } else {
                // Use 'flex' for the container, but individual items are controlled below
                audioControls.style.display = 'flex';
            }
            systemControls.style.display = showSystem ? 'flex' : 'none';
            micControls.style.display = showMic ? 'flex' : 'none';
            masterControls.style.display = (showSystem || showMic) ? 'flex' : 'none';

            // Reset app state when source changes
            resetToIdleState();
            saveSettings();
        });

        document.getElementById('quality').addEventListener('change', saveSettings);
        document.getElementById('framerate').addEventListener('change', saveSettings);

        (function initGainUI(){
          const slider=document.getElementById('audioGainSlider');
          const valEl=document.getElementById('audioGainValue');
          const micSlider=document.getElementById('micGainSlider');
          const micValEl=document.getElementById('micGainValue');
          const systemSlider=document.getElementById('systemGainSlider');
          const systemValEl=document.getElementById('systemGainValue');

          // This is now the MASTER gain, let's remove its UI for now to avoid confusion
          // if(slider&&valEl){
          //   const update=()=>{ 
          //       const v=parseFloat(slider.value); 
          //       valEl.textContent=v.toFixed(1)+'x'; 
          //       if(masterGainNode) masterGainNode.gain.value=v; 
          //   };
          //   slider.addEventListener('input',update); 
          //   update();
          // }

          if(micSlider&&micValEl){
            const updateMic=()=>{ 
                const v=parseFloat(micSlider.value); 
                micValEl.textContent=v.toFixed(1)+'x'; 
                if(micGainNode) micGainNode.gain.value=v; 
            };
            micSlider.addEventListener('input', ()=>{
                updateMic();
                saveSettings();
            }); 
            updateMic();
          }

          if(systemSlider&&systemValEl){
            const updateSystem=()=>{ 
                const v=parseFloat(systemSlider.value); 
                systemValEl.textContent=v.toFixed(1)+'x'; 
                if(systemGainNode) systemGainNode.gain.value=v; 
            };
            systemSlider.addEventListener('input', ()=>{
                updateSystem();
                saveSettings();
            }); 
            updateSystem();
          }
        })();

        function startInputMeter(){
          if(!micInputAnalyser) return; 
          function frame(){
            micInputAnalyser.getByteTimeDomainData(micInputDataArray);
            let rms=0; 
            for(let i=0;i<micInputDataArray.length;i++){ 
                const s=(micInputDataArray[i]-128)/128; rms+=s*s; 
            }
            rms=Math.sqrt(rms/micInputDataArray.length);
            const percent=Math.min(100, rms*400); // sensitivity for mic
            const fill=document.getElementById('micMeterFill');
            if(fill){ 
                fill.style.width=percent+'%'; 
                fill.style.background= percent>75?'#f44336': percent>55?'#ff9800': percent>30?'#ffc107':'#4caf50'; 
            }
            inputMeterAnimationFrame=requestAnimationFrame(frame);
          }
          frame();
        }

        function startSystemMeter(){
          if(!systemInputAnalyser) return; 
          function frame(){
            systemInputAnalyser.getByteTimeDomainData(systemInputDataArray);
            let rms=0; 
            for(let i=0;i<systemInputDataArray.length;i++){ 
                const s=(systemInputDataArray[i]-128)/128; rms+=s*s; 
            }
            rms=Math.sqrt(rms/systemInputDataArray.length);
            const percent=Math.min(100, rms*400);
            const fill=document.getElementById('systemMeterFill');
            if(fill){ 
                fill.style.width=percent+'%'; 
                fill.style.background= percent>75?'#f44336': percent>55?'#ff9800': percent>30?'#ffc107':'#4caf50'; 
            }
            systemMeterAnimationFrame=requestAnimationFrame(frame);
          }
          frame();
        }

        function startOutputMeter(){
          if(!outputAnalyser) return; 
          function frame(){
            outputAnalyser.getByteTimeDomainData(outputDataArray);
            let rms=0; 
            for(let i=0;i<outputDataArray.length;i++){ 
                const s=(outputDataArray[i]-128)/128; rms+=s*s; 
            }
            rms=Math.sqrt(rms/outputDataArray.length);
            const percent=Math.min(100, rms*325);
            const fill=document.getElementById('outputMeterFill');
            if(fill){ 
                fill.style.width=percent+'%'; 
                fill.style.background= percent>75?'#f44336': percent>55?'#ff9800': percent>30?'#ffc107':'#4caf50'; 
            }
            meterAnimationFrame=requestAnimationFrame(frame);
          }
          frame();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            setTimeout(cleanLoadVideoLibrary, 1200);
        });
    </script>
    <div id="videoModal" class="video-modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="video-modal-content">
            <button class="video-modal-close" aria-label="Close video" id="videoModalClose" onclick="closeVideoModal()">✕</button>
            <div class="video-modal-body">
                <div id="videoModalInner" style="width:100%;"></div>
                <div id="videoMetadataSection" class="video-metadata-section" style="display:none;">
                    <div class="video-metadata-left">
                        <div id="metadataItems"></div>
                    </div>
                    <div class="video-metadata-right">
                        <div id="metadataDescription" class="metadata-description"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>