<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers - Sparky Screen Recorder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e2852;
            color: #333;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header-container {
            width: 100%;
            height: 80px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .page-title {
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .customers-table-container {
            background: #2d3748;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow-x: auto;
            border: 1px solid #4a5568;
        }

        .loading-message {
            text-align: center;
            color: #cbd5e0;
            font-size: 18px;
            padding: 40px;
        }

        .customers-table {
            width: 100%;
            border-collapse: collapse;
            background: #1a202c;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .customers-table th {
            background: #4a5568;
            color: #e2e8f0;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 2px solid #2d3748;
        }

        .customers-table td {
            padding: 15px;
            border-bottom: 1px solid #4a5568;
            font-size: 14px;
            color: #e2e8f0;
        }

        .customers-table tr:nth-child(even) {
            background: #2d3748;
        }

        .customers-table tr:hover {
            background: #4a5568;
            cursor: pointer;
        }

        .customer-name {
            font-weight: 600;
            color: #f7fafc;
        }

        .customer-email {
            color: #cbd5e0;
        }

        .customer-id {
            font-family: monospace;
            color: #a0aec0;
            font-size: 12px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .error-message {
            background: #742a2a;
            color: #feb2b2;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid #9b2c2c;
        }

        .customer-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .customer-checkbox:checked {
            accent-color: #764ba2;
        }

        .customers-table tr.selected {
            background: rgba(102, 126, 234, 0.2) !important;
            border-left: 3px solid #667eea;
        }

        .customers-table tr.selected:hover {
            background: rgba(102, 126, 234, 0.3) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container" id="header-container">
            <!-- Global header will be loaded here -->
        </div>

        <div class="main-content">
            <h1 class="page-title">Customer Management</h1>
            
            <div class="stats-row" id="stats-row">
                <div class="stat-card">
                    <div class="stat-number" id="total-customers">-</div>
                    <div class="stat-label">Total Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unique-emails">-</div>
                    <div class="stat-label">Unique Emails</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recent-customers">-</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>

            <div class="customers-table-container">
                <div class="admin-controls" id="admin-controls" style="display: none; margin-bottom: 20px;">
                    <div style="background: rgba(220, 38, 38, 0.1); border: 1px solid #dc2626; border-radius: 8px; padding: 15px;">
                        <h3 style="color: #fca5a5; margin: 0 0 10px 0; font-size: 14px;">üîê Admin Controls</h3>
                        <button onclick="deleteSelectedCustomers()" id="delete-selected-btn" 
                                style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background 0.2s;" 
                                onmouseover="this.style.background='#b91c1c'" 
                                onmouseout="this.style.background='#dc2626'"
                                disabled>
                            üóëÔ∏è Delete Selected from Vimeo
                        </button>
                        <span id="delete-warning" style="color: #fca5a5; font-size: 11px; margin-left: 10px;">
                            Select customers to enable delete
                        </span>
                    </div>
                </div>

                <div class="loading-message" id="loading-message">
                    Loading customers from Vimeo...
                </div>
                
                <div class="error-message" id="error-message" style="display: none;">
                    Failed to load customers. Please check your connection and try again.
                </div>

                <table class="customers-table" id="customers-table" style="display: none;">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="select-all-checkbox" disabled 
                                       style="cursor: not-allowed; opacity: 0.5;" 
                                       title="Select all is disabled">
                            </th>
                            <th>Customer Name</th>
                            <th>Email Address</th>
                            <th>Customer ID</th>
                            <th>First Seen</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-tbody">
                        <!-- Customer rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Load Global Header -->
    <script src="./global-header.js"></script>

    <script>
        // Load customers on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomers();
            checkAdminAccess();
        });

        // Check if current user is admin
        async function checkAdminAccess() {
            try {
                // Get current user session
                if (!window.supabase) {
                    console.log('‚è≥ Waiting for Supabase to load...');
                    setTimeout(checkAdminAccess, 1000);
                    return;
                }

                const { data: { session }, error } = await window.supabase.auth.getSession();
                
                if (error || !session) {
                    console.log('‚ùå No session found');
                    return;
                }

                // Check if user is admin (you can modify this logic as needed)
                const userEmail = session.user.email;
                const adminEmails = ['john@tpnlife.com', 'admin@tpnlife.com']; // Add your admin emails here
                
                if (adminEmails.includes(userEmail.toLowerCase())) {
                    console.log('üîê Admin access granted for:', userEmail);
                    document.getElementById('admin-controls').style.display = 'block';
                } else {
                    console.log('üë§ Regular user access for:', userEmail);
                }
                
            } catch (error) {
                console.error('‚ùå Error checking admin access:', error);
            }
        }

        async function loadCustomers() {
            try {
                console.log('üîÑ Loading customers from API...');
                
                const response = await fetch('/api/get-all-customers');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const customers = await response.json();
                console.log('‚úÖ Loaded customers:', customers.length);
                
                displayCustomers(customers);
                updateStats(customers);
                
            } catch (error) {
                console.error('‚ùå Error loading customers:', error);
                showError();
            }
        }

        function displayCustomers(customers) {
            const loadingMessage = document.getElementById('loading-message');
            const customersTable = document.getElementById('customers-table');
            const tbody = document.getElementById('customers-tbody');
            
            // Hide loading message and show table
            loadingMessage.style.display = 'none';
            customersTable.style.display = 'table';
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            // Add each customer as a row
            customers.forEach((customer, index) => {
                const row = document.createElement('tr');
                row.dataset.customerId = customer.id;
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="customer-checkbox" 
                               data-customer-id="${escapeHtml(customer.id)}"
                               onchange="handleCustomerSelection(this)">
                    </td>
                    <td class="customer-name">${escapeHtml(customer.name || 'Unknown')}</td>
                    <td class="customer-email">${escapeHtml(customer.email || 'No email')}</td>
                    <td class="customer-id">${escapeHtml(customer.id || 'No ID')}</td>
                    <td>${new Date().toLocaleDateString()}</td>
                    <td>
                        <button onclick="viewCustomerDetails('${escapeHtml(customer.id)}')" 
                                style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.2s;" 
                                onmouseover="this.style.background='#764ba2'" 
                                onmouseout="this.style.background='#667eea'">
                            View Details
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Displayed ${customers.length} customers in table`);
        }

        function updateStats(customers) {
            // Update total customers
            document.getElementById('total-customers').textContent = customers.length;
            
            // Update unique emails
            const uniqueEmails = new Set(customers.map(c => c.email?.toLowerCase()).filter(Boolean));
            document.getElementById('unique-emails').textContent = uniqueEmails.size;
            
            // Update recent customers (simulate - in real app you'd check actual dates)
            const recentCount = Math.floor(customers.length * 0.3); // Assume 30% are recent
            document.getElementById('recent-customers').textContent = recentCount;
        }

        function showError() {
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            
            loadingMessage.style.display = 'none';
            errorMessage.style.display = 'block';
        }

        function viewCustomerDetails(customerId) {
            console.log('üìã Viewing details for customer:', customerId);
            // TODO: Implement customer details view
            alert(`Customer details for: ${customerId}\n\nThis feature will be implemented soon!`);
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle individual customer selection
        function handleCustomerSelection(checkbox) {
            const row = checkbox.closest('tr');
            const customerId = checkbox.dataset.customerId;
            
            if (checkbox.checked) {
                row.classList.add('selected');
                console.log('‚úÖ Selected customer:', customerId);
            } else {
                row.classList.remove('selected');
                console.log('‚ùå Deselected customer:', customerId);
            }
            
            updateSelectionCount();
        }

        // Update selection count display
        function updateSelectionCount() {
            const selectedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');
            const count = selectedCheckboxes.length;
            
            // Update page title with selection count
            const pageTitle = document.querySelector('.page-title');
            if (count > 0) {
                pageTitle.textContent = `Customer Management (${count} selected)`;
                pageTitle.style.color = '#67f5b4';
            } else {
                pageTitle.textContent = 'Customer Management';
                pageTitle.style.color = 'white';
            }
            
            // Update admin controls
            const deleteBtn = document.getElementById('delete-selected-btn');
            const deleteWarning = document.getElementById('delete-warning');
            
            if (deleteBtn) {
                if (count > 0) {
                    deleteBtn.disabled = false;
                    deleteBtn.style.opacity = '1';
                    deleteBtn.style.cursor = 'pointer';
                    deleteWarning.textContent = `‚ö†Ô∏è This will permanently delete ${count} customer(s) from Vimeo`;
                } else {
                    deleteBtn.disabled = true;
                    deleteBtn.style.opacity = '0.5';
                    deleteBtn.style.cursor = 'not-allowed';
                    deleteWarning.textContent = 'Select customers to enable delete';
                }
            }
            
            console.log(`üìä ${count} customers selected`);
        }

        // Get selected customer IDs
        function getSelectedCustomers() {
            const selectedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');
            return Array.from(selectedCheckboxes).map(cb => cb.dataset.customerId);
        }

        // Clear all selections
        function clearAllSelections() {
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('tr').classList.remove('selected');
            });
            updateSelectionCount();
        }

        // Delete selected customers from Vimeo
        async function deleteSelectedCustomers() {
            const selectedCustomers = getSelectedCustomers();
            
            if (selectedCustomers.length === 0) {
                alert('Please select customers to delete.');
                return;
            }
            
            // Confirmation dialog
            const confirmed = confirm(
                `‚ö†Ô∏è DANGER: This will permanently delete ${selectedCustomers.length} customer(s) from Vimeo.\n\n` +
                `This action cannot be undone and will remove all their videos and data.\n\n` +
                `Are you absolutely sure you want to continue?`
            );
            
            if (!confirmed) {
                return;
            }
            
            // Second confirmation for safety
            const doubleConfirmed = confirm(
                `üö® FINAL CONFIRMATION üö®\n\n` +
                `You are about to delete ${selectedCustomers.length} customer(s) from Vimeo.\n\n` +
                `Type "DELETE" in the next prompt to confirm.`
            );
            
            if (!doubleConfirmed) {
                return;
            }
            
            const finalConfirmation = prompt('Type "DELETE" to confirm deletion:');
            if (finalConfirmation !== 'DELETE') {
                alert('Deletion cancelled. You must type "DELETE" exactly.');
                return;
            }
            
            try {
                console.log('üóëÔ∏è Starting deletion process for customers:', selectedCustomers);
                
                // Show loading state
                const deleteBtn = document.getElementById('delete-selected-btn');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = 'üîÑ Deleting...';
                deleteBtn.disabled = true;
                
                // Call API to delete customers from Vimeo
                const response = await fetch('/api/delete-customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customerIds: selectedCustomers
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Deletion result:', result);
                
                // Show success message
                alert(`‚úÖ Successfully deleted ${selectedCustomers.length} customer(s) from Vimeo.`);
                
                // Refresh the customer list
                clearAllSelections();
                loadCustomers();
                
            } catch (error) {
                console.error('‚ùå Error deleting customers:', error);
                alert(`‚ùå Error deleting customers: ${error.message}\n\nPlease try again or contact support.`);
                
                // Restore button
                const deleteBtn = document.getElementById('delete-selected-btn');
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }

        // Refresh customers function
        function refreshCustomers() {
            document.getElementById('loading-message').style.display = 'block';
            document.getElementById('customers-table').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            loadCustomers();
        }
    </script>
</body>
</html>