<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparky Screen Recorder - Folders</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Wait for DOM and all scripts to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç DOM loaded, checking Supabase availability:', typeof supabase);
            if (typeof supabase === 'undefined') {
                console.error('‚ùå Supabase library not loaded on DOM ready!');
            } else {
                console.log('‚úÖ Supabase library loaded successfully on DOM ready');
            }
        });
    </script>
    <script src="global-header.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 0 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 600;
            margin: 0;
        }

        .page-header-left {
            display: flex;
            align-items: center;
        }

        .page-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .folder-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #404040;
            min-height: 120px;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
            position: relative;
        }

        .folder-card:hover {
            background: #333333;
            transform: translateY(-2px);
        }

        .folder-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .folder-role {
            font-size: 10px;
            font-weight: 600;
            color: #888888;
            position: absolute;
            bottom: 8px;
            right: 8px;
        }
        
        .folder-email {
            font-size: 10px;
            color: #888888;
            margin-bottom: 10px;
        }

        .folder-display-name {
            font-size: 12px;
            color: #cccccc;
            margin-bottom: 8px;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            color: #ffffff;
            padding: 8px 12px;
            font-size: 14px;
            width: 250px;
            min-width: 200px;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            background: #333333;
        }

        .search-input::placeholder {
            color: #888888;
        }

        .search-results-info {
            text-align: left;
            margin-bottom: 20px;
            color: #cccccc;
            font-size: 14px;
            padding-left: 20px;
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .page-header-left,
            .page-header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-input {
                width: 200px;
            }
        }

        .clear-search-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .clear-search-btn:hover {
            background: #c82333;
        }

        .folder-count {
            font-size: 11px;
            color: #666666;
        }

        .main-folder {
            background: #2d4059;
            border: 1px solid #4a6fa5;
        }

        .main-folder:hover {
            background: #355070;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888888;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        #edit-modal {
            z-index: 2000 !important;
        }

        #edit-modal.show {
            display: flex !important;
            align-items: flex-start !important;
            justify-content: center !important;
            padding-top: 20px !important;
        }

        .modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 50px;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 8px;
            width: 90%;
            height: calc(100vh - 100px);
            max-width: 1400px;
            position: relative;
            overflow: hidden;
        }

        .modal-header {
            background: #2a2a2a;
            padding: 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }

        .modal-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .modal-close:hover {
            color: #ff6b6b;
        }

        .modal-body {
            padding: 20px;
            height: calc(100% - 120px);
            overflow-y: auto;
        }

        /* Search Bar */
        .search-bar {
            position: sticky;
            top: 0;
            background: #1a1a1a;
            padding: 0 0 20px 0;
            margin-bottom: 20px;
            z-index: 100;
            border-bottom: 1px solid #404040;
        }

        .search-input {
            width: 300px;
            padding: 12px 16px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            color: #ffffff;
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a6fa5;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 200;
            display: none;
        }

        .search-result-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #404040;
        }

        .search-result-item:hover {
            background: #3a3a3a;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        /* Video Grid */
        .videos-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .video-card {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #404040;
            transition: all 0.2s ease;
        }

        .video-thumbnail-container {
            position: relative;
        }

        .video-card:hover {
            border-color: #4a6fa5;
            transform: translateY(-2px);
        }

        .video-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #404040;
        }

        .video-info {
            padding: 15px;
        }

        .video-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .video-details {
            font-size: 12px;
            color: #cccccc;
            line-height: 1.4;
        }

        .video-details > div {
            margin-bottom: 4px;
        }

        .video-description {
            margin-top: 8px;
            font-size: 11px;
            color: #aaaaaa;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
        }

        .video-title-old {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .video-meta {
            font-size: 12px;
            color: #888888;
            margin-bottom: 12px;
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(74, 111, 165, 0.9);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }

        .copy-button:hover {
            background: linear-gradient(135deg, #5a7fb5, #3d5069);
            transform: translateY(-1px);
        }

        .copy-button:disabled {
            background: #666666;
            cursor: not-allowed;
            transform: none;
        }

        .edit-button {
            position: absolute;
            top: 8px;
            right: 120px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }

        .edit-button:hover {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <div class="page-header-left">
                <h1>Video Folders</h1>
            </div>
            <div class="page-header-right">
                <div class="search-container">
                    <input type="text" id="search-input" class="search-input" placeholder="üîç Search by name or email..." oninput="filterFolders()" onkeydown="handleSearchKeydown(event)">
                    <button onclick="clearSearch()" class="clear-search-btn">Clear</button>
                </div>
            </div>
        </div>

        <div id="search-results-info" class="search-results-info" style="display: none;"></div>        <div id="folders-container">
            <div class="loading">Loading folders...</div>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="video-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Sparky Screen Recordings</div>
                <button class="modal-close" onclick="closeVideoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-bar">
                    <div style="position: relative;">
                        <input type="text" id="user-search" class="search-input" placeholder="Search users..." oninput="searchUsers(this.value)">
                        <div id="search-results" class="search-results"></div>
                    </div>
                </div>
                <div id="videos-container">
                    <div class="loading">Loading videos...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Video Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">Edit Video Metadata</div>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #ffffff; font-weight: 600;">Title:</label>
                        <input type="text" id="edit-title" style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #404040; border-radius: 6px; color: #ffffff; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #ffffff; font-weight: 600;">Customer Name:</label>
                        <input type="text" id="edit-customer-name" style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #404040; border-radius: 6px; color: #ffffff; font-size: 14px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #ffffff; font-weight: 600;">Customer Email:</label>
                        <input type="email" id="edit-customer-email" style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #404040; border-radius: 6px; color: #ffffff; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #ffffff; font-weight: 600;">Recorded By Name:</label>
                        <input type="text" id="edit-recorded-by-name" style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #404040; border-radius: 6px; color: #ffffff; font-size: 14px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #ffffff; font-weight: 600;">Recorded By Email:</label>
                        <input type="email" id="edit-recorded-by-email" style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #404040; border-radius: 6px; color: #ffffff; font-size: 14px;">
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #ffffff; font-weight: 600;">Additional Notes:</label>
                    <textarea id="edit-description" rows="4" placeholder="Any additional notes or description..." style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #404040; border-radius: 6px; color: #ffffff; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="text-align: right;">
                    <button onclick="closeEditModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 6px; margin-right: 10px; cursor: pointer;">Cancel</button>
                    <button onclick="saveVideoChanges()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase with error handling
        const supabaseUrl = 'https://bwvxctexiseobyqcublc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3dnhjdGV4aXNlb2J5cWN1YmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNzc1NzMsImV4cCI6MjA3MDg1MzU3M30.7QGmKxE24-BfbEJpxFrxORAJuN_ZLzt9-d6904Gx0ug';
        
        // Robust Supabase initialization
        function initializeSupabase() {
            console.log('üöÄ Attempting Supabase initialization...');
            console.log('üîç typeof supabase:', typeof supabase);
            console.log('üîç window.supabase exists:', !!window.supabase);
            
            if (typeof supabase !== 'undefined') {
                try {
                    window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('‚úÖ Supabase initialized successfully');
                    console.log('üîó Supabase client created:', !!window.supabase);
                    return true;
                } catch (error) {
                    console.error('‚ùå Error creating Supabase client:', error);
                    return false;
                }
            } else {
                console.log('‚è≥ Supabase library not yet available, retrying...');
                setTimeout(initializeSupabase, 200);
                return false;
            }
        }
        
        // Start initialization when script loads
        initializeSupabase();

        // Authentication and role-based access control
        // Authentication check using Supabase session
        async function checkAuthAndRole() {
            try {
                console.log('üîê Starting authentication check...');
                console.log('üîç Supabase client status:', !!window.supabase);
                
                // Wait for Supabase to be available
                if (!window.supabase) {
                    console.log('‚è≥ Waiting for Supabase to load...');
                    setTimeout(checkAuthAndRole, 100);
                    return;
                }

                const { data: { session }, error } = await window.supabase.auth.getSession();
                
                if (error || !session) {
                    console.log('üîí No Supabase session found - redirecting to login');
                    window.location.href = 'login.html';
                    return false;
                }

                // Get user profile to check role
                const { data: profile, error: profileError } = await window.supabase
                    .from('profiles')
                    .select('role')
                    .eq('id', session.user.id)
                    .single();

                const role = profile?.role?.toLowerCase() || 'user';
                if (role !== 'admin' && role !== 'manager' && role !== 'supervisor') {
                    alert('Access denied: Admin, Manager, or Supervisor role required for Folders page');
                    window.location.href = 'index.html';
                    return false;
                }
                
                console.log('‚úÖ Full access granted for role:', role);
                
                console.log('‚úÖ User authenticated with role:', role);
                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Check authentication when page loads
        window.addEventListener('load', async () => {
            console.log('üìÑ Page loaded, starting authentication check...');
            
            // Ensure Supabase is initialized before proceeding
            if (!window.supabase) {
                console.log('‚è≥ Waiting for Supabase initialization...');
                setTimeout(async () => {
                    if (!(await checkAuthAndRole())) {
                        return;
                    }
                    initializePage();
                }, 500);
                return;
            }
            
            if (!(await checkAuthAndRole())) {
                return; // Redirect will happen in the function
            }
            
            console.log('üöÄ Authentication successful, calling initializePage()...');
            // Continue with page initialization
            await initializePage();
        });

        // Global variables
        let folders = [];
        let allFolders = []; // Store original unfiltered folders
        let videos = [];
        let allVideos = []; // Store all videos globally for copying
        let selectedVideoForCopy = null;
        let filteredUsers = [];
        let currentFolderType = null; // Track current folder type ('main' or 'user')
        let currentFolderData = null; // Track current folder data
        let originalVideoDescription = null; // Track original description for update comparison
        let videoUpdatesCache = new Map(); // Cache for updated video data (URI -> updated video object)

        async function initializePage() {
            console.log('üéØ initializePage() function called!');
            // Variables are now global, function just initializes
            
            // Load folders when page initializes
            console.log('üîÑ Starting loadFolders() from initializePage()...');
            try {
                await loadFolders();
                console.log('‚úÖ loadFolders() completed successfully');
            } catch (error) {
                console.error('‚ùå loadFolders() failed:', error);
            }
        }

        // Load user video counts from localStorage
        function loadUserVideoCounts() {
            const userVideos = JSON.parse(localStorage.getItem('userVideos') || '{}');
            
            for (const folder of folders.filter(f => f.type === 'user')) {
                const count = userVideos[folder.userId] ? userVideos[folder.userId].length : 0;
                updateUserVideoCount(folder.userId, count);
            }
        }

        async function refreshFolders() {
            console.log('üîÑ Refreshing folders and videos...');
            const foldersContainer = document.getElementById('folders-container');
            foldersContainer.innerHTML = '<div class="loading">Refreshing videos...</div>';
            
            // Clear cache and reload everything
            folders = [];
            videos = [];
            allVideos = [];
            await loadFolders();
        }

        async function loadFolders() {
            try {
                console.log('üé¨ loadFolders() function started...');
                console.log('Loading folders and videos efficiently...');
                
                // Load users from Supabase
                const usersResponse = await fetch('/api/users');
                if (!usersResponse.ok) throw new Error('Failed to load users');
                const usersData = await usersResponse.json();
                const users = usersData.users || [];

                // Create folders array (main folder will be added after videos are loaded)
                folders = [];

                // Add user folders with role information and sort by role then name
                const sortedUsers = users.sort((a, b) => {
                    // First sort by role (admin > supervisor > manager > user > others)
                    const roleOrder = { 
                        'admin': 1, 
                        'supervisor': 2, 
                        'manager': 3, 
                        'user': 4 
                    };
                    const aRole = roleOrder[a.role?.toLowerCase()] || 99;
                    const bRole = roleOrder[b.role?.toLowerCase()] || 99;
                    
                    if (aRole !== bRole) {
                        return aRole - bRole;
                    }
                    
                    // Then sort alphabetically by display name
                    const aName = (a.display_name || a.email || 'Unknown').toLowerCase();
                    const bName = (b.display_name || b.email || 'Unknown').toLowerCase();
                    return aName.localeCompare(bName);
                });
                
                console.log(`ÔøΩ Loading videos for ${sortedUsers.length} users using same API as index.html...`);
                
                // Load all videos once and assign to users (much more efficient)
                console.log(`üöÄ Loading all videos once for efficient assignment...`);
                const allVideosResponse = await fetch('/api/folder-videos');
                if (!allVideosResponse.ok) throw new Error('Failed to load videos');
                const allVideosData = await allVideosResponse.json();
                const videoList = allVideosData.videos || [];
                allVideos = applyLocalUpdates(videoList); // Store globally for copying functionality
                videos = allVideos; // Also set global videos for main folder display
                
                // Create user email map for fast lookup
                const usersByEmail = new Map();
                sortedUsers.forEach(user => {
                    usersByEmail.set(user.email.toLowerCase(), user);
                });
                
                // Assign videos to users using the same server logic
                const userVideosMap = new Map();
                let johnVideoFound = false;
                
                allVideos.forEach(video => {
                    const desc = video.description || '';
                    
                    // Special debugging for john@tpnlife.com
                    if (desc.includes('john@tpnlife.com') || video.name === 'Test 9281') {
                        console.log('üîç DEBUGGING JOHN VIDEO:', {
                            name: video.name,
                            description: desc.substring(0, 200) + '...',
                            fullDescription: desc,
                            uri: video.uri
                        });
                        johnVideoFound = true;
                    }
                    
                    const match = desc.match(/Recorded By Email:\s*([^\n]+)/);
                    if (match) {
                        const recordedByEmail = match[1].trim().toLowerCase();
                        
                        if (recordedByEmail === 'john@tpnlife.com') {
                            console.log('‚úÖ JOHN VIDEO MATCHED:', {
                                email: recordedByEmail,
                                videoName: video.name,
                                match: match[1]
                            });
                        }
                        
                        if (!userVideosMap.has(recordedByEmail)) {
                            userVideosMap.set(recordedByEmail, []);
                        }
                        userVideosMap.get(recordedByEmail).push({
                            id: video.uri.split('/').pop(),
                            uri: video.uri,
                            name: video.name || 'Unknown Customer', // Use name, not customerName
                            link: video.link, // Use link, not vimeoLink
                            pictures: video.pictures, // Keep full pictures object for thumbnails
                            duration: video.duration || 0, // Include duration
                            created_time: video.created_time, // Use created_time, not createdTime
                            description: desc
                        });
                    }
                });
                
                console.log('üß™ JOHN DEBUG SUMMARY:', {
                    johnVideoFound: johnVideoFound,
                    johnVideosAssigned: userVideosMap.get('john@tpnlife.com')?.length || 0,
                    allEmailsFound: Array.from(userVideosMap.keys())
                });
                
                console.log(`ÔøΩ EFFICIENT ASSIGNMENT: Processed ${allVideos.length} videos in single batch`);
                
                // Create folders for all Supabase users
                sortedUsers.forEach(user => {
                    const userVideos = userVideosMap.get(user.email.toLowerCase()) || [];
                    console.log(`üìß ${user.email}: assigned ${userVideos.length} videos`);
                    
                    const folderData = {
                        id: `user-${user.id}`,
                        name: user.display_name || user.email || 'Unknown User',
                        type: 'user',
                        videoCount: userVideos.length,
                        displayName: user.display_name || '',
                        email: user.email || '',
                        role: user.role || 'User',
                        userId: user.id,
                        userVideos: userVideos
                    };
                    
                    // Debug John's folder specifically
                    if (user.email.toLowerCase() === 'john@tpnlife.com') {
                        console.log('üîß JOHN FOLDER DEBUG:', {
                            userEmail: user.email,
                            userVideosLength: userVideos.length,
                            folderVideoCount: folderData.videoCount,
                            folderName: folderData.name,
                            userVideos: userVideos
                        });
                    }
                    
                    folders.push(folderData);
                });
                
                // Add main Sparky folder at the beginning
                folders.unshift({
                    id: 'main',
                    name: 'Sparky Screen Recordings',
                    type: 'main',
                    videoCount: allVideos.length,
                    displayName: '',
                    email: ''
                });
                
                console.log(`‚úÖ Created ${folders.length - 1} user folders from Supabase users (plus main folder)`);
                console.log('Folder breakdown:', folders.map(f => `${f.name}: ${f.videoCount} videos`));

                // Store original folders for search filtering
                allFolders = [...folders];
                displayFolders();
                
            } catch (error) {
                console.error('Error loading folders:', error);
                document.getElementById('folders-container').innerHTML = 
                    '<div class="error">Failed to load folders: ' + error.message + '</div>';
            }
        }

        function applyLocalUpdates(videoList) {
            // Apply any locally cached updates to the video list
            return videoList.map(video => {
                if (videoUpdatesCache.has(video.uri)) {
                    const cachedUpdate = videoUpdatesCache.get(video.uri);
                    console.log(`üì± Applying local cache for ${video.uri}`);
                    return { ...video, ...cachedUpdate };
                }
                return video;
            });
        }

        async function reloadVideos() {
            try {
                console.log('Reloading videos with fresh data...');
                
                // Force fresh fetch with cache busting
                const videosResponse = await fetch(`/api/folder-videos?t=${Date.now()}`);
                if (!videosResponse.ok) throw new Error('Failed to reload videos');
                const videosData = await videosResponse.json();
                
                // Apply local updates to fresh data
                videos = applyLocalUpdates(videosData.videos || []);
                allVideos = videos; // Update global videos array
                
                console.log(`Reloaded ${videos.length} videos`);
                
                // Debug: Check if the specific video we just edited has new data
                if (currentEditVideoUri && videos.length > 0) {
                    const updatedVideo = videos.find(v => v.uri === currentEditVideoUri);
                    if (updatedVideo) {
                        console.log('Found updated video:', updatedVideo.uri);
                        console.log('Video description (with local updates):', updatedVideo.description?.substring(0, 100) + '...');
                        const details = parseVideoDescription(updatedVideo.description || '');
                        console.log('Updated video parsed details:', details);
                    } else {
                        console.log('Could not find updated video with URI:', currentEditVideoUri);
                    }
                }
                
                // Debug: log first video to see overall state
                if (videos.length > 0) {
                    console.log('Sample video (first in list):', videos[0].uri);
                    console.log('Sample description:', videos[0].description?.substring(0, 100) + '...');
                }
            } catch (error) {
                console.error('Error reloading videos:', error);
            }
        }

        function displayFolders() {
            const container = document.getElementById('folders-container');
            
            if (folders.length === 0) {
                container.innerHTML = '<div class="error">No folders found</div>';
                return;
            }

            const foldersHTML = folders.map(folder => {
                const isMain = folder.type === 'main';
                const cardClass = isMain ? 'folder-card main-folder' : 'folder-card';
                
                return `
                    <div class="${cardClass}" onclick="openFolder('${folder.id}', '${folder.type}')">
                        <div class="folder-title">${escapeHtml(folder.name)}</div>
                        ${folder.email ? `<div class="folder-email">${escapeHtml(folder.email)}</div>` : ''}
                        <div class="folder-count">${folder.videoCount} videos</div>
                        ${folder.role ? `<div class="folder-role">${escapeHtml(folder.role)}</div>` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="folders-grid">${foldersHTML}</div>`;
        }

        function openFolder(folderId, folderType) {
            console.log(`Opening folder: ${folderId} (${folderType})`);
            
            // Set current folder tracking
            currentFolderType = folderType;
            currentFolderData = { id: folderId, type: folderType };
            
            if (folderType === 'main') {
                openVideoModal();
            } else {
                // Extract the actual user ID from the folder ID (remove 'user-' prefix)
                const userId = folderId.startsWith('user-') ? folderId.substring(5) : folderId;
                console.log(`Extracted userId: ${userId} from folderId: ${folderId}`);
                currentFolderData.userId = userId;
                // Show user folder videos
                showUserVideos(userId);
            }
        }

        function openVideoModal() {
            const modal = document.getElementById('video-modal');
            modal.classList.add('show');
            displayVideos();
        }

        function closeVideoModal() {
            const modal = document.getElementById('video-modal');
            modal.classList.remove('show');
        }

        // Close modal when clicking on overlay
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('video-modal');
            if (e.target === modal) {
                closeVideoModal();
            }
        });

        // Edit video functions
        let currentEditVideoUri = null;

        function openEditModalSafe(buttonElement) {
            const videoUri = buttonElement.getAttribute('data-video-uri');
            const title = buttonElement.getAttribute('data-video-title');
            
            // Find the video data from allVideos array
            const video = allVideos.find(v => v.uri === videoUri);
            const description = video ? video.description || '' : '';
            
            openEditModal(videoUri, title, description);
        }

        function openEditModal(videoUri, title, description) {
            currentEditVideoUri = videoUri;
            originalVideoDescription = description; // Store original for comparison
            document.getElementById('edit-title').value = title;
            
            // Parse the description to extract structured data
            const parsedData = parseVideoDescription(description);
            document.getElementById('edit-customer-name').value = parsedData.customerName || '';
            document.getElementById('edit-customer-email').value = parsedData.customerEmail || '';
            document.getElementById('edit-recorded-by-name').value = parsedData.recordedBy || '';
            document.getElementById('edit-recorded-by-email').value = parsedData.recordedByEmail || '';
            document.getElementById('edit-description').value = parsedData.additionalNotes || '';
            
            const modal = document.getElementById('edit-modal');
            modal.classList.add('show');
        }

        function parseVideoDescription(description) {
            const data = {
                customerName: '',
                customerEmail: '',
                recordedBy: '',
                recordedByEmail: '',
                additionalNotes: ''
            };
            
            if (!description) return data;
            
            // Parse existing format patterns
            const customerNameMatch = description.match(/Customer:\s*([^\n\r]+)/i);
            const customerEmailMatch = description.match(/Customer Email:\s*([^\n\r]+)/i);
            const recordedByMatch = description.match(/Recorded by:\s*([^\n\r]+)/i);
            const recordedByEmailMatch = description.match(/Recorded By Email:\s*([^\n\r]+)/i);
            
            if (customerNameMatch) data.customerName = customerNameMatch[1].trim();
            if (customerEmailMatch) data.customerEmail = customerEmailMatch[1].trim();
            if (recordedByMatch) data.recordedBy = recordedByMatch[1].trim();
            if (recordedByEmailMatch) data.recordedByEmail = recordedByEmailMatch[1].trim();
            
            // Extract additional notes (everything that's not structured data)
            let notes = description;
            notes = notes.replace(/Customer:\s*[^\n\r]+/gi, '');
            notes = notes.replace(/Customer Email:\s*[^\n\r]+/gi, '');
            notes = notes.replace(/Recorded by:\s*[^\n\r]+/gi, '');
            notes = notes.replace(/Recorded By Email:\s*[^\n\r]+/gi, '');
            notes = notes.replace(/\n\s*\n/g, '\n').trim();
            
            data.additionalNotes = notes;
            
            return data;
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.remove('show');
            currentEditVideoUri = null;
        }

        async function saveVideoChanges() {
            if (!currentEditVideoUri) return;
            
            const title = document.getElementById('edit-title').value.trim();
            const customerName = document.getElementById('edit-customer-name').value.trim();
            const customerEmail = document.getElementById('edit-customer-email').value.trim();
            const recordedByName = document.getElementById('edit-recorded-by-name').value.trim();
            const recordedByEmail = document.getElementById('edit-recorded-by-email').value.trim();
            const additionalNotes = document.getElementById('edit-description').value.trim();
            
            if (!title) {
                alert('Title is required');
                return;
            }
            
            // Build structured description
            let description = '';
            
            if (customerName) {
                description += `Customer: ${customerName}\n`;
            }
            if (customerEmail) {
                description += `Customer Email: ${customerEmail}\n`;
            }
            if (recordedByName) {
                description += `Recorded by: ${recordedByName}\n`;
            }
            if (recordedByEmail) {
                description += `Recorded by Email: ${recordedByEmail}\n`;
            }
            if (additionalNotes) {
                if (description) description += '\n';
                description += additionalNotes;
            }
            
            try {
                const response = await fetch('/api/update-video', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoUri: currentEditVideoUri,
                        title: title,
                        description: description
                    })
                });
                
                // Check if response is ok and content-type is JSON
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Server response not ok:', response.status, text);
                    alert('Server error: ' + response.status + ' - ' + text.substring(0, 200));
                    return;
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response is not JSON:', contentType, text);
                    alert('Server returned non-JSON response: ' + text.substring(0, 200));
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Video updated successfully!');
                    closeEditModal();
                    
                    // Cache the updated data locally for immediate display
                    const updatedVideoData = {
                        name: title,
                        description: description
                    };
                    videoUpdatesCache.set(currentEditVideoUri, updatedVideoData);
                    console.log('üíæ Cached local update for video:', currentEditVideoUri);
                    
                    // Immediately refresh display with cached data
                    await reloadVideos(); // This will apply local cache
                    if (currentFolderType === 'main') {
                        displayVideos(); // Refresh main folder videos with cached data
                    } else if (currentFolderType === 'user' && currentFolderData) {
                        showUserVideos(currentFolderData.userId); // Refresh user folder videos with cached data
                    }
                    
                    // Check in background if Vimeo has propagated the changes
                    let retryCount = 0;
                    const maxRetries = 3;
                    const checkVimeoUpdate = async () => {
                        // Fetch fresh data WITHOUT applying local cache
                        const videosResponse = await fetch(`/api/folder-videos?t=${Date.now()}`);
                        const videosData = await videosResponse.json();
                        const freshVideo = videosData.videos?.find(v => v.uri === currentEditVideoUri);
                        
                        if (freshVideo && freshVideo.description !== originalVideoDescription) {
                            console.log('‚úÖ Vimeo update confirmed - removing local cache');
                            videoUpdatesCache.delete(currentEditVideoUri); // Remove cache since Vimeo is now up to date
                        } else if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`‚è≥ Vimeo not updated yet, retry ${retryCount}/${maxRetries} in 30 seconds...`);
                            setTimeout(checkVimeoUpdate, 30000); // Check every 30 seconds
                        } else {
                            console.log('‚ö†Ô∏è Vimeo still not updated after retries, keeping local cache');
                        }
                    };
                    
                    setTimeout(checkVimeoUpdate, 10000); // Check Vimeo after 10 seconds
                } else {
                    alert('Error updating video: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating video:', error);
                alert('Error updating video: ' + error.message);
            }
        }

        // Close edit modal when clicking on overlay
        document.addEventListener('click', function(e) {
            const editModal = document.getElementById('edit-modal');
            if (e.target === editModal) {
                closeEditModal();
            }
        });

        function displayVideos() {
            const container = document.getElementById('videos-container');
            
            if (!videos || videos.length === 0) {
                container.innerHTML = '<div class="error">No videos found</div>';
                return;
            }

            const videosHTML = videos.map(video => {
                const thumbnail = video.pictures?.sizes?.find(size => size.width >= 300)?.link || 
                                 video.pictures?.sizes?.[0]?.link || '';
                const title = video.name || 'Untitled Video';
                const duration = formatDuration(video.duration || 0);
                const createdDate = video.created_time ? new Date(video.created_time).toLocaleDateString() : 'Unknown';
                const videoId = video.uri?.split('/').pop() || '';
                
                // Parse recording details from description
                const recordingDetails = parseRecordingDetails(video.description || '');
                
                // Debug: log first video's description to see format
                if (videos.indexOf(video) === 0) {
                    console.log('Sample video description:', video.description);
                    console.log('Parsed details:', recordingDetails);
                    console.log('Video user info:', video.user);
                }

                return `
                    <div class="video-card">
                        <div class="video-thumbnail-container">
                            ${thumbnail ? `<img src="${thumbnail}" alt="${escapeHtml(title)}" class="video-thumbnail">` : '<div class="video-thumbnail"></div>'}
                            <button class="copy-button" onclick="showCopyOptions('${video.uri}', '${escapeHtml(title)}')">
                                Copy to folder
                            </button>
                            <button class="edit-button" data-video-uri="${video.uri}" data-video-title="${escapeHtml(title)}" onclick="openEditModalSafe(this)">
                                Edit
                            </button>
                        </div>
                        <div class="video-info">
                            <div class="video-title">${escapeHtml(title)}</div>
                            <div class="video-meta">
                                <div>${duration} - ${createdDate}</div>
                                ${video.user?.name ? `<div><strong>Uploaded by:</strong> ${escapeHtml(video.user.name)}</div>` : ''}
                                ${recordingDetails.recordedBy ? `<div><strong>Recorded by:</strong> ${escapeHtml(recordingDetails.recordedBy)}</div>` : ''}
                                ${recordingDetails.customerName ? `<div><strong>Customer:</strong> ${escapeHtml(recordingDetails.customerName)}</div>` : ''}
                                ${recordingDetails.customerEmail ? `<div><strong>Customer Email:</strong> ${escapeHtml(recordingDetails.customerEmail)}</div>` : ''}
                                ${recordingDetails.recordedByEmail ? `<div><strong>Recorder Email:</strong> ${escapeHtml(recordingDetails.recordedByEmail)}</div>` : ''}
                                ${recordingDetails.recordingDate ? `<div><strong>Recording Date:</strong> ${escapeHtml(recordingDetails.recordingDate)}</div>` : ''}
                                ${video.description ? `<div><strong>Full Description:</strong><br><pre style="white-space: pre-wrap; font-size: 10px; color: #aaa; margin: 4px 0;">${escapeHtml(video.description)}</pre></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="videos-grid">${videosHTML}</div>`;
        }

        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function parseRecordingDetails(description) {
            const details = {
                customerName: '',
                customerEmail: '',
                recordedBy: '',
                recordedByEmail: '',
                recordingDate: ''
            };

            if (!description) return details;

            // Extract customer name
            const customerNameMatch = description.match(/(?:Name|Customer):\s*([^\n]+?)(?:\s*Email:|$)/i);
            if (customerNameMatch) {
                details.customerName = customerNameMatch[1].trim();
            }

            // Extract customer email (try multiple patterns)
            const customerEmailMatch = description.match(/(?:Customer Email|Email):\s*([^\s\n]+)/i);
            if (customerEmailMatch) {
                details.customerEmail = customerEmailMatch[1];
            }

            // Extract recorded by name
            const recordedByMatch = description.match(/Recorded by:\s*([^\n]+)/i);
            if (recordedByMatch) {
                details.recordedBy = recordedByMatch[1].trim();
            }

            // Extract recorded by email
            const recordedByEmailMatch = description.match(/Recorded by email:\s*([^\s\n]+)/i);
            if (recordedByEmailMatch) {
                details.recordedByEmail = recordedByEmailMatch[1];
            }

            // Extract recording date
            const recordingDateMatch = description.match(/Recording Date:\s*([^\n]+)/);
            if (recordingDateMatch) {
                details.recordingDate = recordingDateMatch[1].trim();
            }

            return details;
        }

        function showCopyOptions(videoUri, videoTitle) {
            selectedVideoForCopy = { uri: videoUri, title: videoTitle };
            const searchInput = document.getElementById('user-search');
            const searchResults = document.getElementById('search-results');
            
            // Focus search input
            searchInput.focus();
            searchInput.placeholder = `Search users to copy "${videoTitle}"...`;
            
            // Show all users initially
            showSearchResults('');
        }

        function searchUsers(query) {
            const searchResults = document.getElementById('search-results');
            
            if (!query.trim()) {
                searchResults.style.display = 'none';
                return;
            }

            // Filter users based on search query
            const allUsers = folders.filter(f => f.type === 'user');
            filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase()) ||
                user.email.toLowerCase().includes(query.toLowerCase())
            );

            showSearchResults(query);
        }

        function showSearchResults(query) {
            const searchResults = document.getElementById('search-results');
            
            if (!selectedVideoForCopy) {
                searchResults.style.display = 'none';
                return;
            }

            const usersToShow = query ? filteredUsers : folders.filter(f => f.type === 'user');
            
            if (usersToShow.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No users found</div>';
                searchResults.style.display = 'block';
                return;
            }

            const resultsHTML = usersToShow.map(user => `
                <div class="search-result-item" onclick="copyVideoToUser('${user.userId}', '${escapeHtml(user.name)}')">
                    <div style="font-weight: 600;">${escapeHtml(user.name)}</div>
                    <div style="font-size: 11px; color: #888;">${escapeHtml(user.email)}</div>
                </div>
            `).join('');

            searchResults.innerHTML = resultsHTML;
            searchResults.style.display = 'block';
        }

        function copyVideoToUser(userId, userName) {
            if (!selectedVideoForCopy) return;
            
            console.log(`Copying video "${selectedVideoForCopy.title}" to user: ${userName}`);
            
            // Initialize user videos storage if it doesn't exist
            if (!localStorage.getItem('userVideos')) {
                localStorage.setItem('userVideos', JSON.stringify({}));
            }
            
            // Get current user videos
            const userVideos = JSON.parse(localStorage.getItem('userVideos'));
            if (!userVideos[userId]) {
                userVideos[userId] = [];
            }
            
            // Find the full video data from our loaded videos
            const fullVideoData = allVideos.find(v => v.uri === selectedVideoForCopy.uri);
            if (fullVideoData) {
                // Check if video is already assigned to avoid duplicates
                const alreadyAssigned = userVideos[userId].some(v => v.uri === fullVideoData.uri);
                if (!alreadyAssigned) {
                    userVideos[userId].push(fullVideoData);
                    localStorage.setItem('userVideos', JSON.stringify(userVideos));
                    
                    // Update the folder display with new video count
                    updateUserVideoCount(userId, userVideos[userId].length);
                    
                    alert(`Video "${selectedVideoForCopy.title}" copied to ${userName}! (${userVideos[userId].length} total videos)`);
                } else {
                    alert(`Video "${selectedVideoForCopy.title}" is already in ${userName}'s folder.`);
                }
            } else {
                alert('Error: Could not find video data to copy.');
            }
            
            // Clear selection and hide search results
            selectedVideoForCopy = null;
            document.getElementById('user-search').value = '';
            document.getElementById('user-search').placeholder = 'Search users...';
            document.getElementById('search-results').style.display = 'none';
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-bar');
            if (!searchContainer.contains(e.target)) {
                document.getElementById('search-results').style.display = 'none';
            }
        });

        function updateUserVideoCount(userId, count) {
            // Find the user folder and update its display
            const folder = folders.find(f => f.userId === userId);
            if (folder) {
                folder.videoCount = count;
                // Update the DOM - look for the folder using the full folder ID
                const folderId = `user-${userId}`;
                const folderElement = document.querySelector(`[onclick*="'${folderId}'"]`);
                if (folderElement) {
                    const countElement = folderElement.querySelector('.folder-count');
                    if (countElement) {
                        countElement.textContent = `${count} videos`;
                    }
                }
            }
        }

        function showUserVideos(userId) {
            console.log(`showUserVideos called for userId: ${userId}`);
            
            // Find the user folder and get their automatically assigned videos
            const userFolder = folders.find(f => f.userId === userId);
            if (!userFolder) {
                alert('User folder not found.');
                return;
            }
            
            const videos = userFolder.userVideos || [];
            console.log(`Videos automatically assigned to ${userFolder.name}:`, videos);
            console.log(`Number of videos found: ${videos.length}`);
            
            if (videos.length === 0) {
                alert(`No recordings found for ${userFolder.name}. Videos are automatically assigned based on the "Recorded by Email" field in video metadata.`);
                return;
            }
            
            // Open modal and display user's videos
            const modal = document.getElementById('video-modal');
            const videoGrid = document.getElementById('videos-container');
            const modalTitle = document.querySelector('.modal-title');
            
            modalTitle.textContent = `${userFolder.name}'s Recordings (${videos.length})`;
            
            // Display videos with custom layout - values only in specific order
            const videosHTML = videos.map(video => {
                const thumbnail = video.pictures?.sizes?.find(size => size.width >= 300)?.link || 
                                 video.pictures?.sizes?.[0]?.link || '';
                const duration = formatDuration(video.duration || 0);
                const createdDate = video.created_time ? new Date(video.created_time).toLocaleDateString() : 'Unknown';
                const recordingDetails = parseRecordingDetails(video.description || '');
                
                // Use video name as customer name if no customer name found in description
                const customerName = recordingDetails.customerName || video.name || 'Unknown Customer';
                
                // Extract description without the recording details section
                const cleanDescription = video.description ? 
                    video.description.split('--- RECORDING DETAILS ---')[0].trim() : '';

                return `
                    <div class="video-card">
                        <div class="video-thumbnail-container">
                            ${thumbnail ? `<img src="${thumbnail}" alt="Video thumbnail" class="video-thumbnail">` : '<div class="video-thumbnail"></div>'}
                            <button class="copy-button" onclick="removeVideoFromUser('${userId}', '${video.uri}', 'Video')">Remove</button>
                        </div>
                        <div class="video-info">
                            <div class="video-details">
                                <div>${escapeHtml(customerName)}</div>
                                <div>${escapeHtml(recordingDetails.customerEmail || 'No email')}</div>
                                <div>${escapeHtml(recordingDetails.recordedBy || 'Unknown')}</div>
                                <div>${escapeHtml(recordingDetails.recordedByEmail || 'No email')}</div>
                                <div>${duration} - ${createdDate}</div>
                            </div>
                            ${cleanDescription ? `<div class="video-description">${escapeHtml(cleanDescription)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            videoGrid.innerHTML = videosHTML;
            modal.classList.add('show');
        }

        function removeVideoFromUser(userId, videoUri, videoTitle) {
            if (confirm(`Remove "${videoTitle}" from this folder?`)) {
                const userVideos = JSON.parse(localStorage.getItem('userVideos') || '{}');
                if (userVideos[userId]) {
                    userVideos[userId] = userVideos[userId].filter(v => v.uri !== videoUri);
                    localStorage.setItem('userVideos', JSON.stringify(userVideos));
                    
                    // Update count and refresh display
                    updateUserVideoCount(userId, userVideos[userId].length);
                    showUserVideos(userId); // Refresh the modal
                    
                    alert(`Video removed successfully!`);
                }
            }
        }

        // Search and filtering functions
        function filterFolders() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const resultsInfo = document.getElementById('search-results-info');
            
            if (!searchTerm) {
                // Show all folders when search is empty
                folders = [...allFolders];
                resultsInfo.style.display = 'none';
            } else {
                // Filter folders by name or email
                folders = allFolders.filter(folder => {
                    const nameMatch = folder.name.toLowerCase().includes(searchTerm);
                    const emailMatch = folder.email ? folder.email.toLowerCase().includes(searchTerm) : false;
                    const displayNameMatch = folder.displayName ? folder.displayName.toLowerCase().includes(searchTerm) : false;
                    
                    return nameMatch || emailMatch || displayNameMatch;
                });
                
                // Show search results info
                const totalCount = allFolders.length - 1; // Subtract 1 for main folder
                const filteredCount = folders.length - (folders.some(f => f.type === 'main') ? 1 : 0); // Account for main folder
                resultsInfo.innerHTML = `Found ${filteredCount} of ${totalCount} folders matching "${searchTerm}"`;
                resultsInfo.style.display = 'block';
            }
            
            displayFolders();
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results-info').style.display = 'none';
            folders = [...allFolders];
            displayFolders();
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Escape') {
                clearSearch();
                event.target.blur();
            }
        }

        // Global keyboard shortcut to focus search (Ctrl+F or Cmd+F)
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
                event.preventDefault();
                document.getElementById('search-input').focus();
            }
        });

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
