<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Folders</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1e2852; color: #fff; min-height: 100vh; }
        .container { width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
        .header-container { width: 100%; height: 80px; position: sticky; top: 0; z-index: 1000; }
        .main-content { flex: 1; padding: 20px; }
        .folders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .folder-card { background: #444; border: 2px solid #666; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; }
        .folder-card:hover { transform: translateY(-2px); border-color: #4CAF50; }
        .folder-card.main-folder { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #4CAF50; }
        .folder-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .folder-email { font-size: 14px; color: #ccc; margin-bottom: 4px; }
        .folder-count { font-size: 16px; color: #4CAF50; font-weight: bold; }
        .folder-role { font-size: 12px; background: #4CAF50; color: #000; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-top: 8px; }
        .error { color: #ff4444; text-align: center; padding: 40px; }
        .back-to-folders { position: sticky; top: 60px; z-index: 1000; margin-bottom: 20px; }
        .back-to-folders button { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3); transition: all 0.3s ease; }
        .back-to-folders button:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4); background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%); }
        .back-to-folders button:active { transform: translateY(0); }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .video-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.75); display: none; align-items: center; justify-content: center; z-index: 20000; padding: 24px; }
        .video-modal-overlay.open { display: flex; }
        .video-modal-content { width: 100%; max-width: 1200px; background: #000; border-radius: 10px; overflow: hidden; position: relative; }
        .video-modal-close { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.1); color: #fff; border: none; width: 38px; height: 38px; border-radius: 50%; cursor: pointer; font-size: 18px; }
        .video-modal-body video, .video-modal-body iframe { width: 100%; height: 70vh; background: #000; display: block; }
        .video-metadata-section { width: 100%; background: #1a1a1a; display: flex; border-top: 1px solid #333; }
        .video-metadata-left { width: 33%; background: #2a2a2a; padding: 20px; border-right: 1px solid #333; }
        .video-metadata-right { width: 67%; padding: 20px; background: #1a1a1a; }
        .metadata-item { color: #e2e8f0; font-size: 14px; margin-bottom: 8px; }
        .metadata-description { color: #cbd5e1; font-size: 14px; line-height: 1.5; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container"></div>
        <div class="main-content">
            <div id="folders-container">
                <!-- Folder grid will be built by script -->
            </div>
            <div id="video-grid-container" style="display:none;">
                <div id="video-grid">
                    <!-- Video cards will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <div id="videoModal" class="video-modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="video-modal-content">
            <button class="video-modal-close" aria-label="Close video" id="videoModalClose" onclick="closeVideoModal()">‚úï</button>
            <div class="video-modal-body">
                <div id="videoModalInner" style="width:100%;"></div>
                <div id="videoMetadataSection" class="video-metadata-section" style="display:none;">
                    <div class="video-metadata-left">
                        <div id="metadataItems"></div>
                    </div>
                    <div class="video-metadata-right">
                        <div id="metadataDescription" class="metadata-description"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="global-header.js"></script>
    <script>
        // Debug header loading
        console.log('üîç FOLDERS.HTML DEBUG: Script loaded');
        console.log('üîç Global header functions available:', typeof window.loadGlobalHeader);
        console.log('üîç Window supabase exists:', !!window.supabase);
        
        // Check if header loaded and force load if needed
        setTimeout(() => {
            const headerExists = !!document.querySelector('.header');
            const userDropdown = !!document.getElementById('user-dropdown');
            console.log('üîç After 1s - Header elements:', {
                userDropdown,
                userName: !!document.getElementById('user-name'),
                headerExists
            });
            
            if (!headerExists && typeof window.loadGlobalHeader === 'function') {
                console.log('üîÑ Header not found, attempting to load it manually...');
                window.loadGlobalHeader();
            }
        }, 1000);
        
        // Additional fallback for DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (!document.querySelector('.header') && typeof window.loadGlobalHeader === 'function') {
                    console.log('üîÑ DOM ready - loading header manually...');
                    window.loadGlobalHeader();
                }
            }, 100);
        });
        
        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        function getCurrentUserInfo() {
            if (window.getCurrentUser && typeof window.getCurrentUser === 'function') {
                return window.getCurrentUser();
            }
            return { displayName: 'Unknown User', email: 'unknown@example.com' };
        }
        
        // Supabase client is now initialized in global-header.js
        // We will wait for it to be ready.
        let supabase;

        document.addEventListener('profileLoaded', () => {
            console.log('üì¢ profileLoaded event received in folders.html');
            if (window.supabase) {
                supabase = window.supabase;
                console.log('‚úÖ Supabase client ready in folders.html');
                initializeApp();
            } else {
                console.error('‚ùå Supabase client not found after profileLoaded event.');
            }
        });
        
        // Multiple fallback initialization methods
        let initializationAttempted = false;
        
        function tryInitialization() {
            if (initializationAttempted) return;
            
            console.log('üîÑ Attempting fallback initialization...');
            console.log('Window supabase exists:', !!window.supabase);
            console.log('Local supabase exists:', !!supabase);
            
            if (!supabase && window.supabase) {
                console.log('‚úÖ Using fallback initialization');
                supabase = window.supabase;
                initializationAttempted = true;
                initializeApp();
                return true;
            }
            return false;
        }
        
        // Try multiple times with increasing delays
        setTimeout(() => tryInitialization(), 1000);
        setTimeout(() => tryInitialization(), 3000);
        setTimeout(() => tryInitialization(), 5000);
        
        // Also try when the page is fully loaded
        window.addEventListener('load', () => {
            setTimeout(() => tryInitialization(), 500);
        });

        async function initializeApp() {
            try {
                console.log('üöÄ Initializing folders app...');
                // All the functions that depend on supabase can now be called.
                await loadFolders();
                console.log('‚úÖ Folders app initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing app:', error);
                document.getElementById('folders-container').innerHTML = 
                    '<div class="error">Failed to initialize: ' + error.message + '</div>';
            }
        }
        
        // State variables
        let folders = [], allFolders = [], videos = [], allVideos = [];
        let currentFolderData = null;
        let currentFolderType = 'main';
        let supabaseUser, supabaseUsers = [];
        let videoUpdatesCache = new Map();
        let selectedUserForMove = null;

        // Initialize the page
        // The initialization is now triggered by the 'profileLoaded' event.

        // Fetch and display folders
        async function loadFolders() {
            try {
                console.log('üé¨ loadFolders() function started...');
                console.log('Loading folders and videos efficiently...');
                
                // Load users from Supabase
                const usersResponse = await fetch('/api/users');
                if (!usersResponse.ok) throw new Error('Failed to load users');
                const usersData = await usersResponse.json();
                const users = usersData.users || [];

                // Create folders array - start fresh to avoid duplicates
                folders = [];

                // Add user folders with role information and sort by role then name
                const sortedUsers = users.sort((a, b) => {
                    // First sort by role (admin > supervisor > manager > user > others)
                    const roleOrder = { 
                        'admin': 1, 
                        'supervisor': 2, 
                        'manager': 3, 
                        'user': 4 
                    };
                    const aRole = roleOrder[a.role?.toLowerCase()] || 99;
                    const bRole = roleOrder[b.role?.toLowerCase()] || 99;
                    
                    if (aRole !== bRole) {
                        return aRole - bRole;
                    }
                    
                    // Then sort alphabetically by display name
                    const aName = (a.display_name || a.email || 'Unknown').toLowerCase();
                    const bName = (b.display_name || b.email || 'Unknown').toLowerCase();
                    return aName.localeCompare(bName);
                });
                
                console.log(`ÔøΩ Loading videos for ${sortedUsers.length} users using same API as index.html...`);
                
                // Load all videos once and assign to users (much more efficient)
                console.log(`üöÄ Loading all videos once for efficient assignment...`);
                const allVideosResponse = await fetch('/api/folder-videos');
                if (!allVideosResponse.ok) throw new Error('Failed to load videos');
                const allVideosData = await allVideosResponse.json();
                const videoList = allVideosData.videos || [];
                allVideos = applyLocalUpdates(videoList); // Store globally for copying functionality
                videos = allVideos; // Also set global videos for main folder display
                
                // Create user email map for fast lookup
                const usersByEmail = new Map();
                sortedUsers.forEach(user => {
                    usersByEmail.set(user.email.toLowerCase(), user);
                });
                
                // Assign videos to users using the same server logic
                const userVideosMap = new Map();
                let johnVideoFound = false;
                
                allVideos.forEach(video => {
                    const desc = video.description || '';
                    
                    // Special debugging for john@tpnlife.com
                    if (desc.includes('john@tpnlife.com') || video.name === 'Test 9281') {
                        console.log('üîç DEBUGGING JOHN VIDEO:', {
                            name: video.name,
                            description: desc.substring(0, 200) + '...',
                            fullDescription: desc,
                            uri: video.uri
                        });
                        johnVideoFound = true;
                    }
                    
                    const match = desc.match(/Recorded By Email:\s*([^\n]+)/);
                    if (match) {
                        const recordedByEmail = match[1].trim().toLowerCase();
                        
                        if (recordedByEmail === 'john@tpnlife.com') {
                            console.log('‚úÖ JOHN VIDEO MATCHED:', {
                                email: recordedByEmail,
                                videoName: video.name,
                                match: match[1]
                            });
                        }
                        
                        if (!userVideosMap.has(recordedByEmail)) {
                            userVideosMap.set(recordedByEmail, []);
                        }
                        userVideosMap.get(recordedByEmail).push({
                            id: video.uri.split('/').pop(),
                            uri: video.uri,
                            name: video.name || 'Unknown Customer', // Use name, not customerName
                            link: video.link, // Use link, not vimeoLink
                            pictures: video.pictures, // Keep full pictures object for thumbnails
                            duration: video.duration || 0, // Include duration
                            created_time: video.created_time, // Use created_time, not createdTime
                            description: desc
                        });
                    }
                });
                
                console.log('üß™ JOHN DEBUG SUMMARY:', {
                    johnVideoFound: johnVideoFound,
                    johnVideosAssigned: userVideosMap.get('john@tpnlife.com')?.length || 0,
                    allEmailsFound: Array.from(userVideosMap.keys())
                });
                
                console.log(`ÔøΩ EFFICIENT ASSIGNMENT: Processed ${allVideos.length} videos in single batch`);
                
                // First, add the main Sparky folder at the beginning
                folders.push({
                    id: 'main',
                    name: 'Sparky Screen Recordings',
                    type: 'main',
                    videoCount: allVideos.length,
                    displayName: '',
                    email: ''
                });
                
                // Then add user folders (excluding any that might duplicate the main folder)
                sortedUsers.forEach(user => {
                    const userVideos = userVideosMap.get(user.email.toLowerCase()) || [];
                    console.log(`üìß ${user.email}: assigned ${userVideos.length} videos`);
                    
                    const folderData = {
                        id: `user-${user.id}`,
                        name: user.display_name || user.email || 'Unknown User',
                        type: 'user',
                        videoCount: userVideos.length,
                        displayName: user.display_name || '',
                        email: user.email || '',
                        role: user.role || 'User',
                        userId: user.id,
                        userVideos: userVideos
                    };
                    
                    // Debug John's folder specifically
                    if (user.email.toLowerCase() === 'john@tpnlife.com') {
                        console.log('üîß JOHN FOLDER DEBUG:', {
                            userEmail: user.email,
                            userVideosLength: userVideos.length,
                            folderVideoCount: folderData.videoCount,
                            folderName: folderData.name,
                            userVideos: userVideos
                        });
                    }
                    
                    folders.push(folderData);
                });
                
            console.log(`‚úÖ Created ${folders.length - 1} user folders from Supabase users (plus main folder)`);
            console.log('Folder breakdown:', folders.map(f => `${f.name}: ${f.videoCount} videos`));

            // Store original folders for search filtering
            allFolders = [...folders];
            displayFolders();
            
        } catch (error) {
            console.error('Error loading folders:', error);
            document.getElementById('folders-container').innerHTML = 
                '<div class="error">Failed to load folders: ' + error.message + '</div>';
        }
    }

    function showMainVideos() {
        console.log('Showing main folder videos');
        document.getElementById('folders-container').style.display = 'none';
        document.getElementById('video-grid-container').style.display = 'block';
        
        // Add back button
        const videoGridContainer = document.getElementById('video-grid-container');
        const backButton = `
            <div class="back-to-folders">
                <button onclick="backToFolders()">
                    <span>‚Üê</span> Back to Folders
                </button>
            </div>
        `;
        
        const container = document.getElementById('video-grid');
        if (!container) return;
        
        if (!allVideos || allVideos.length === 0) {
            videoGridContainer.innerHTML = backButton + '<div id="video-grid"><div style="grid-column: 1 / -1; text-align: center; color: #ccc; padding: 40px 0;">No videos found in main folder.</div></div>';
            return;
        }
        
        videoGridContainer.innerHTML = backButton + '<div id="video-grid"></div>';
        const newContainer = document.getElementById('video-grid');
        displayVideosInGrid(allVideos, newContainer);
    }        function applyLocalUpdates(videoList) {
            // Apply any locally cached updates to the video list
            return videoList.map(video => {
                if (videoUpdatesCache.has(video.uri)) {
                    const cachedUpdate = videoUpdatesCache.get(video.uri);
                    console.log(`üì± Applying local cache for ${video.uri}`);
                    return { ...video, ...cachedUpdate };
                }
                return video;
            });
        }

        async function reloadVideos() {
            try {
                console.log('Reloading videos with fresh data...');
                
                // Force fresh fetch with cache busting
                const videosResponse = await fetch(`/api/folder-videos?t=${Date.now()}`);
                if (!videosResponse.ok) throw new Error('Failed to reload videos');
                const videosData = await videosResponse.json();
                
                // Apply local updates to fresh data
                videos = applyLocalUpdates(videosData.videos || []);
                allVideos = videos; // Update global videos array
                
                console.log(`Reloaded ${videos.length} videos`);
                
                // Debug: Check if the specific video we just edited has new data
                if (currentEditVideoUri && videos.length > 0) {
                    const updatedVideo = videos.find(v => v.uri === currentEditVideoUri);
                    if (updatedVideo) {
                        console.log('Found updated video:', updatedVideo.uri);
                        console.log('Video description (with local updates):', updatedVideo.description?.substring(0, 100) + '...');
                        const details = parseVideoDescription(updatedVideo.description || '');
                        console.log('Updated video parsed details:', details);
                    } else {
                        console.log('Could not find updated video with URI:', currentEditVideoUri);
                    }
                }
                
                // Debug: log first video to see overall state
                if (videos.length > 0) {
                    console.log('Sample video (first in list):', videos[0].uri);
                    console.log('Sample description:', videos[0].description?.substring(0, 100) + '...');
                }
            } catch (error) {
                console.error('Error reloading videos:', error);
            }
        }

        function displayFolders() {
            const container = document.getElementById('folders-container');
            
            if (!container) {
                console.error('folders-container not found');
                return;
            }
            
            if (folders.length === 0) {
                container.innerHTML = '<div class="error">No folders found</div>';
                return;
            }

            const foldersHTML = folders.map(folder => {
                const isMain = folder.type === 'main';
                const cardClass = isMain ? 'folder-card main-folder' : 'folder-card';
                
                return `
                    <div class="${cardClass}" onclick="openFolder('${folder.id}', '${folder.type}')">
                        <div class="folder-title">${escapeHtml(folder.name)}</div>
                        ${folder.email ? `<div class="folder-email">${escapeHtml(folder.email)}</div>` : ''}
                        <div class="folder-count">${folder.videoCount} videos</div>
                        ${folder.role ? `<div class="folder-role">${escapeHtml(folder.role)}</div>` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="folders-grid">${foldersHTML}</div>`;
        }

        function openFolder(folderId, folderType) {
            console.log(`Opening folder: ${folderId} (${folderType})`);
            
            // Set current folder tracking
            currentFolderType = folderType;
            currentFolderData = { id: folderId, type: folderType };
            
            if (folderType === 'main') {
                // Show main folder videos
                showMainVideos();
            } else {
                // Extract the actual user ID from the folder ID (remove 'user-' prefix)
                const userId = folderId.startsWith('user-') ? folderId.substring(5) : folderId;
                console.log(`Extracted userId: ${userId} from folderId: ${folderId}`);
                currentFolderData.userId = userId;
                // Find the folder data
                const folderData = folders.find(f => f.id === folderId);
                if (folderData && folderData.userVideos) {
                    showUserVideos(userId, folderData.userVideos);
                } else {
                    console.error('Folder data not found for:', folderId);
                }
            }
        }

        function openVideoModal() {
            const modal = document.getElementById('video-modal');
            modal.classList.add('show');
            displayVideos();
        }

        function closeVideoModal() {
            const modal = document.getElementById('video-modal');
            modal.classList.remove('show');
        }

        // Close modal when clicking on overlay
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('video-modal');
            if (e.target === modal) {
                closeVideoModal();
            }
        });

        // Edit video functions
        let currentEditVideoUri = null;

        function openEditModalSafe(buttonElement) {
            const videoUri = buttonElement.getAttribute('data-video-uri');
            const title = buttonElement.getAttribute('data-video-title');
            
            // Find the video data from allVideos array
            const video = allVideos.find(v => v.uri === videoUri);
            const description = video ? video.description || '' : '';
            
            openEditModal(videoUri, title, description);
        }

        function openEditModal(videoUri, title, description) {
            currentEditVideoUri = videoUri;
            originalVideoDescription = description; // Store original for comparison
            document.getElementById('edit-title').value = title;
            
            // Parse the description to extract structured data
            const parsedData = parseVideoDescription(description);
            document.getElementById('edit-customer-name').value = parsedData.customerName || '';
            document.getElementById('edit-customer-email').value = parsedData.customerEmail || '';
            document.getElementById('edit-recorded-by-name').value = parsedData.recordedBy || '';
            document.getElementById('edit-recorded-by-email').value = parsedData.recordedByEmail || '';
            document.getElementById('edit-description').value = parsedData.additionalNotes || '';
            
            const modal = document.getElementById('edit-modal');
            modal.classList.add('show');
        }

        function parseVideoDescription(description) {
            const data = {
                customerName: '',
                customerEmail: '',
                recordedBy: '',
                recordedByEmail: '',
                additionalNotes: ''
            };
            
            if (!description) return data;
            
            // Parse existing format patterns
            const customerNameMatch = description.match(/Customer:\s*([^\n\r]+)/i);
            const customerEmailMatch = description.match(/Customer Email:\s*([^\n\r]+)/i);
            const recordedByMatch = description.match(/Recorded by:\s*([^\n\r]+)/i);
            const recordedByEmailMatch = description.match(/Recorded By Email:\s*([^\n\r]+)/i);
            
            if (customerNameMatch) data.customerName = customerNameMatch[1].trim();
            if (customerEmailMatch) data.customerEmail = customerEmailMatch[1].trim();
            if (recordedByMatch) data.recordedBy = recordedByMatch[1].trim();
            if (recordedByEmailMatch) data.recordedByEmail = recordedByEmailMatch[1].trim();
            
            // Extract additional notes (everything that's not structured data)
            let notes = description;
            notes = notes.replace(/Customer:\s*[^\n\r]+/gi, '');
            notes = notes.replace(/Customer Email:\s*[^\n\r]+/gi, '');
            notes = notes.replace(/Recorded by:\s*[^\n\r]+/gi, '');
            notes = notes.replace(/Recorded By Email:\s*[^\n\r]+/gi, '');
            notes = notes.replace(/\n\s*\n/g, '\n').trim();
            
            data.additionalNotes = notes;
            
            return data;
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.remove('show');
            currentEditVideoUri = null;
        }

        async function saveVideoChanges() {
            if (!currentEditVideoUri) return;
            
            const title = document.getElementById('edit-title').value.trim();
            const customerName = document.getElementById('edit-customer-name').value.trim();
            const customerEmail = document.getElementById('edit-customer-email').value.trim();
            const recordedByName = document.getElementById('edit-recorded-by-name').value.trim();
            const recordedByEmail = document.getElementById('edit-recorded-by-email').value.trim();
            const additionalNotes = document.getElementById('edit-description').value.trim();
            
            if (!title) {
                alert('Title is required');
                return;
            }
            
            // Build structured description
            let description = '';
            
            if (customerName) {
                description += `Customer: ${customerName}\n`;
            }
            if (customerEmail) {
                description += `Customer Email: ${customerEmail}\n`;
            }
            if (recordedByName) {
                description += `Recorded by: ${recordedByName}\n`;
            }
            if (recordedByEmail) {
                description += `Recorded by Email: ${recordedByEmail}\n`;
            }
            if (additionalNotes) {
                if (description) description += '\n';
                description += additionalNotes;
            }
            
            try {
                const response = await fetch('/api/update-video', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoUri: currentEditVideoUri,
                        title: title,
                        description: description
                    })
                });
                
                // Check if response is ok and content-type is JSON
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Server response not ok:', response.status, text);
                    alert('Server error: ' + response.status + ' - ' + text.substring(0, 200));
                    return;
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response is not JSON:', contentType, text);
                    alert('Server returned non-JSON response: ' + text.substring(0, 200));
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Video updated successfully!');
                    closeEditModal();
                    
                    // Cache the updated data locally for immediate display
                    const updatedVideoData = {
                        name: title,
                        description: description
                    };
                    videoUpdatesCache.set(currentEditVideoUri, updatedVideoData);
                    console.log('üíæ Cached local update for video:', currentEditVideoUri);
                    
                    // Immediately refresh display with cached data
                    await reloadVideos(); // This will apply local cache
                    if (currentFolderType === 'main') {
                        showMainVideos(); // Refresh main folder videos with cached data
                    } else if (currentFolderType === 'user' && currentFolderData) {
                        const folderData = folders.find(f => f.id === `user-${currentFolderData.userId}`);
                        if (folderData && folderData.userVideos) {
                            showUserVideos(currentFolderData.userId, folderData.userVideos);
                        }
                    }
                    
                    // Check in background if Vimeo has propagated the changes
                    let retryCount = 0;
                    const maxRetries = 3;
                    const checkVimeoUpdate = async () => {
                        // Fetch fresh data WITHOUT applying local cache
                        const videosResponse = await fetch(`/api/folder-videos?t=${Date.now()}`);
                        const videosData = await videosResponse.json();
                        const freshVideo = videosData.videos?.find(v => v.uri === currentEditVideoUri);
                        
                        if (freshVideo && freshVideo.description !== originalVideoDescription) {
                            console.log('‚úÖ Vimeo update confirmed - removing local cache');
                            videoUpdatesCache.delete(currentEditVideoUri); // Remove cache since Vimeo is now up to date
                        } else if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`‚è≥ Vimeo not updated yet, retry ${retryCount}/${maxRetries} in 30 seconds...`);
                            setTimeout(checkVimeoUpdate, 30000); // Check every 30 seconds
                        } else {
                            console.log('‚ö†Ô∏è Vimeo still not updated after retries, keeping local cache');
                        }
                    };
                    
                    setTimeout(checkVimeoUpdate, 10000); // Check Vimeo after 10 seconds
                } else {
                    alert('Error updating video: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating video:', error);
                alert('Error updating video: ' + error.message);
            }
        }

        // Close edit modal when clicking on overlay
        document.addEventListener('click', function(e) {
            const editModal = document.getElementById('edit-modal');
            if (e.target === editModal) {
                closeEditModal();
            }
        });

        function displayVideos(videos, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (videos.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #ccc; padding: 40px 0;">No videos found for this folder.</div>';
                return;
            }

            let html = '';
            videos.forEach(video => {
                const details = parseVideoDescription(video.fullDescription);
                const videoUserInfo = supabaseUsers.find(u => u.email === details.recordedByEmail);

                const name = video.name || 'Unknown';
                const fullDesc = video.fullDescription || '';
                const onclickAttribute = `openVideoModalWithMetadata('${video.vimeoLink}','${name.replace(/'/g, '\\\'')}','${fullDesc.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')`;

                html += `
                    <div class="video-card" style="background:#444;border:2px solid #666;border-radius:12px;overflow:hidden;transition:.3s;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4);" onclick="${onclickAttribute}">
                        <div style="position:relative;width:100%;height:160px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;">
                            ${video.thumbnail ? `<img src='${video.thumbnail}' style='width:100%;height:100%;object-fit:cover;'>` : `<div style='text-align:center;'><div style='font-size:36px;margin-bottom:8px;'>üé¨</div><div style='font-size:12px;opacity:.8;'>Click to View</div></div>`}
                            <div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,.8);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px;font-weight:bold;border:1px solid #4CAF50;">${new Date(details.recordingDate).toLocaleDateString()}</div>
                        </div>
                        <div style="padding:12px;">
                            <div style="font-size:14px;font-weight:bold;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(video.name)}</div>
                            <div style="font-size:12px;color:#ddd;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(details.customerName || 'No customer name')}</div>
                            <div style="font-size:12px;color:#ddd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(details.recordedBy || 'Unknown recorder')}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showUserVideos(userId, videos) {
            console.log(`Showing videos for user: ${userId}`);
            document.getElementById('folders-container').style.display = 'none';
            document.getElementById('video-grid-container').style.display = 'block';
            
            // Add back button
            const videoGridContainer = document.getElementById('video-grid-container');
            const backButton = `
                <div class="back-to-folders">
                    <button onclick="backToFolders()">
                        <span>‚Üê</span> Back to Folders
                    </button>
                </div>
            `;
            
            if (!videos || videos.length === 0) {
                videoGridContainer.innerHTML = backButton + '<div id="video-grid"><div style="grid-column: 1 / -1; text-align: center; color: #ccc; padding: 40px 0;">No videos found for this user.</div></div>';
                return;
            }

            videoGridContainer.innerHTML = backButton + '<div id="video-grid"></div>';
            const container = document.getElementById('video-grid');
            displayVideosInGrid(videos, container);
        }

        function displayVideosInGrid(videos, container) {
            let html = '';
            videos.forEach(video => {
                const name = video.name || 'Unknown';
                const description = video.description || '';
                const videoUrl = video.link || '';
                const thumbnail = video.pictures?.sizes?.[0]?.link || null;
                const createdDate = new Date(video.created_time || Date.now()).toLocaleDateString();
                
                // Parse description for details
                const customerEmailMatch = description.match(/Customer Email:\s*([^\n\r]+)/);
                const recordedByMatch = description.match(/Recorded By:\s*([^\n\r]+)/);
                
                const customerEmail = customerEmailMatch ? customerEmailMatch[1].trim() : '';
                const recordedBy = recordedByMatch ? recordedByMatch[1].trim() : 'Unknown';
                
                const safeVideoUrl = videoUrl.replace(/'/g, '\\\'');
                const safeName = name.replace(/'/g, '\\\'');
                const safeDescription = description.replace(/'/g, '\\\\').replace(/"/g, '&quot;');
                
                html += `
                    <div class="video-card" style="background:#444;border:2px solid #666;border-radius:12px;overflow:hidden;transition:.3s;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4);" onclick="openVideoModalWithMetadata('${safeVideoUrl}','${safeName}','${safeDescription}')">
                        <div style="position:relative;width:100%;height:160px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;">
                            ${thumbnail ? `<img src='${thumbnail}' style='width:100%;height:100%;object-fit:cover;'>` : `<div style='text-align:center;'><div style='font-size:36px;margin-bottom:8px;'>üé¨</div><div style='font-size:12px;opacity:.8;'>Click to View</div></div>`}
                            <div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,.8);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px;font-weight:bold;border:1px solid #4CAF50;">${createdDate}</div>
                        </div>
                        <div style="padding:12px;">
                            <div style="font-size:14px;font-weight:bold;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(name)}</div>
                            <div style="font-size:12px;color:#ddd;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(customerEmail || 'No customer email')}</div>
                            <div style="font-size:12px;color:#ddd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(recordedBy)}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ===== Modal Functions (Copied from index.html for consistency) =====
        function openVideoModal(url, title, metadata = null) {
            try {
                const modal = document.getElementById('videoModal');
                const inner = document.getElementById('videoModalInner');
                inner.innerHTML = '';

                if (/vimeo\.com|player\.vimeo\.com/.test(url)) {
                    let src = url;
                    if (/^https:\/\/(www\.)?vimeo\.com\/.+/.test(url)) {
                        const m = url.match(/vimeo\.com\/(?:video\/)?(\d+)/);
                        if (m && m[1]) src = `https://player.vimeo.com/video/${m[1]}?autoplay=1`;
                    } else if (url.indexOf('player.vimeo.com') !== -1 && url.indexOf('autoplay') === -1) {
                        src += (url.indexOf('?') === -1 ? '?' : '&') + 'autoplay=1';
                    }
                    const iframe = document.createElement('iframe');
                    iframe.src = src;
                    iframe.allow = 'autoplay; fullscreen; picture-in-picture';
                    iframe.allowFullscreen = true;
                    iframe.frameBorder = '0';
                    inner.appendChild(iframe);
                } else if (url && (url.startsWith('blob:') || /(\.mp4|\.webm|\.ogg)$/i.test(url))) {
                    const v = document.createElement('video');
                    v.src = url;
                    v.controls = true;
                    v.autoplay = true;
                    v.playsInline = true;
                    v.addEventListener('canplay', () => {
                        const p = v.play();
                        if (p && p.catch) p.catch(() => {});
                    });
                    inner.appendChild(v);
                } else {
                    window.open(url, '_blank');
                    return;
                }

                const metadataSection = document.getElementById('videoMetadataSection');
                if (metadata) {
                    const items = document.getElementById('metadataItems');
                    const desc = document.getElementById('metadataDescription');
                    let html = '';
                    if (metadata.customerName) html += `<div class="metadata-item">üë§ ${metadata.customerName}</div>`;
                    if (metadata.customerEmail) html += `<div class="metadata-item">üìß ${metadata.customerEmail}</div>`;
                    if (metadata.recordedBy) html += `<div class="metadata-item">üé¨ ${metadata.recordedBy}</div>`;
                    if (metadata.recordedByEmail) html += `<div class="metadata-item">üì® ${metadata.recordedByEmail}</div>`;
                    if (metadata.recordingDate) html += `<div class="metadata-item">üïí ${new Date(metadata.recordingDate).toLocaleString()}</div>`;
                    items.innerHTML = html;
                    desc.textContent = (metadata.description || 'No description available');
                    metadataSection.style.display = 'flex';
                } else {
                    metadataSection.style.display = 'none';
                }

                modal._ignoreClicks = true;
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
                setTimeout(() => { modal._ignoreClicks = false; }, 50);
                modal._previouslyFocused = document.activeElement;
                document.getElementById('videoModalClose').focus();
            } catch (e) {
                console.error("Error in openVideoModal:", e);
                window.open(url, '_blank');
            }
        }

        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            if (!modal) return;
            const inner = document.getElementById('videoModalInner');
            const el = inner.querySelector('video,iframe');
            if (el) {
                try {
                    if (el.tagName.toLowerCase() === 'video') {
                        el.pause();
                        if (el.src && el.src.startsWith('blob:')) URL.revokeObjectURL(el.src);
                    }
                    if (el.tagName.toLowerCase() === 'iframe') el.src = '';
                } catch (e) {
                    console.error("Error closing video modal content:", e);
                }
            }
            inner.innerHTML = '';
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            const prev = modal._previouslyFocused;
            if (prev && prev.focus) prev.focus();
        }

        function openVideoModalWithMetadata(url, title, description) {
            const recordedByMatch = description.match(/Recorded By:\s*([^\n\r]+)/);
            const recordedByEmailMatch = description.match(/Recorded By Email:\s*([^\n\r]+)/);
            const customerEmailMatch = description.match(/Customer Email:\s*([^\n\r]+)/);
            const recordingDateMatch = description.match(/Recording Date:\s*([^\n\r]+)/);
            const userInfo = getCurrentUserInfo();
            const mainDesc = description.split('--- RECORDING DETAILS ---')[0].trim();
            const cleanDesc = mainDesc || description || 'No description available';
            const metadata = {
                customerName: title,
                customerEmail: customerEmailMatch ? customerEmailMatch[1].trim() : '',
                recordedBy: recordedByMatch ? recordedByMatch[1].trim() : userInfo.displayName,
                recordedByEmail: recordedByEmailMatch ? recordedByEmailMatch[1].trim() : userInfo.email,
                recordingDate: recordingDateMatch ? recordingDateMatch[1].trim() : new Date().toLocaleString(),
                description: cleanDesc
            };
            openVideoModal(url, title, metadata);
        }

        document.addEventListener('click', e => {
            const modal = document.getElementById('videoModal');
            if (!modal || !modal.classList.contains('open') || modal._ignoreClicks) return;
            const content = modal.querySelector('.video-modal-content');
            if (content && !content.contains(e.target)) {
                closeVideoModal();
            }
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('videoModal');
                if (modal && modal.classList.contains('open')) {
                    closeVideoModal();
                }
            }
        });

        // Back to folders function
        function backToFolders() {
            console.log('Returning to folders view');
            document.getElementById('video-grid-container').style.display = 'none';
            document.getElementById('folders-container').style.display = 'block';
            currentFolderType = 'main';
            currentFolderData = null;
        }
        
        window.openVideoModal = openVideoModal;
        window.closeVideoModal = closeVideoModal;
        window.openVideoModalWithMetadata = openVideoModalWithMetadata;
        window.backToFolders = backToFolders;
    </script>
</body>
</html>
